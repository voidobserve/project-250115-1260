C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LED_CTRL
OBJECT MODULE PLACED IN .\Release\Objects\led_ctrl.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\led_ctrl.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C) I
                    -NCDIR(..\..\Libraries\Include;..\..\User) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\led_ctrl.lst) OBJECT(.
                    -\Release\Objects\led_ctrl.obj)

line level    source

   1          #include "include.h"
   2          #include "main.h"
   3          #include <math.h>
   4          #include <stdio.h>
   5          
   6          #include "user_config.h"
   7          
   8          
   9          
  10          extern void pwm_in_handler(void);
  11          extern u16 ntc_val;
  12          extern u16 adc0_val;
  13          extern u16 adc1_val;
  14          
  15          
  16          bit ex_temp_en; // è¿‡æ¸©é™åŠŸç‡æ ‡å¿—ä½
  17          // #define L_PWR_T     (1*10)
  18          
  19          /* LIN æ”¹çš„åœ°æ–¹æœ‰ï¼š
  20                           å¢åŠ adc.cæ–‡ä»¶
  21                           åŠ å…¥äº†ç”µä½å™¨å€¼çš„åˆ¤æ–­                void adjust_pwm()
  22                           åŠ å…¥äº†è¿‡æ¸©é™åŠŸç‡å‡½æ•°                ex_temp_adjust_timer()
  23                                           LIN æ”¹ åŠ å…¥äº†ç”µä½å™¨ å°†æ—¶æ§æ•°å€¼æ”¹åŠ¨  void t_ctrl_timer_handl
             -er(void)
  24                                           åŠ å…¥äº†ntcå’Œç”µä½å™¨çš„è°ƒèŠ‚æ ‡å¿—ä½åˆ¤æ–­   option_fun(void)
  25                                           ä¸€å°æ—¶é™åŠŸç‡ä¸­åŠ å…¥äº†ç”µä½å™¨å€¼è½¬æ¢    l_pwr_timer_handler(v
             -oid)
  26                                           ç¼“å¯åŠ¨æ— ä¸‰åˆä¸€æ—¶å°†æœ€å¤§äº®åº¦æ”¹ä¸ºç”µä½å™¨çš„å€¼   void led_p
             -wr_on(void)
  27          */
  28          typedef struct
  29          {
  30              u32 t;    // è®¡æ—¶å™¨
  31              u8 level; // æ—¶ç©ºåˆ—è¡¨æ‰§è¡Œçš„å“ªä¸€ä¸ªæ—¶é—´æ®µ
  32              u8 list;  // æ—¶æ§åˆ—è¡¨ï¼Œ5ä¸ªåˆ—è¡¨
  33              u8 en;    // ä½¿èƒ½
  34          } t_ctrl_t;   // æ—¶æ§ç»“æ„ä½“
  35          
  36          typedef struct
  37          {
  38              u8 en;
  39              u8 act; // åŠ¨ä½œï¼Œæ‰§è¡Œé™åŠŸç‡åŠ¨ä½œï¼š1
  40              u32 t;  // ç§’
  41          
  42          } l_pwr_t; // é™åŠŸç‡ç»“æ„ä½“
  43          
  44          typedef struct
  45          {
  46              u8 en;
  47          } _3_1_t; // ä¸‰åˆä¸€ç»“æ„ä½“
  48          
  49          u8 cap_10ms_cnt; // 10msè·å–ä¸€æ¬¡æ•è·å ç©ºæ¯”
  50          u8 pwr_on_cnt;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 2   

  51          u16 c_duty = 0;      // å½“å‰è®¾ç½®çš„å ç©ºæ¯”
  52          u32 pwm_in_duty = 0; // ä¸‰åˆä¸€PWMè¾“å…¥çš„å ç©ºæ¯”
  53          u32 pwm_in_duty_xuwei = 0;
  54          u32 ex_pwm_in_duty = 0;
  55          u16 ex_max_duty = 0;
  56          u16 max_duty = 6000; // å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”
  57          t_ctrl_t t_ctrl;
  58          l_pwr_t l_pwr;
  59          _3_1_t _3_1;
  60          bit dly_pwr_on = 0;
  61          u8 dly_pwr_on_cnt = 0;
  62          // 1ï¼šæ­£åœ¨é™åŠŸç‡ï¼Œè°ƒç”¨ç¼“å‡ç¼“é™é€»è¾‘
  63          /*
  64              ç¼“æ…¢å‡é™åŠŸç‡æ˜¯å¦ä½¿èƒ½çš„æ ‡å¿—ä½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œ1--ä½¿èƒ½
  65          */
  66          bit is_pwr_down = 0;
  67          bit adjust_en;
  68          // æ—¶æ§æ¨¡å¼0ï¼š100%6H 50%6H 0%
  69          // æ—¶æ§æ¨¡å¼1ï¼š100%4H 50%8H 0%
  70          // æ—¶æ§æ¨¡å¼2ï¼š100%5H 70%3H 50%4H 0%
  71          // æ—¶æ§æ¨¡å¼3ï¼š100%4H 70%4H 50%4H 0%
  72          // æ—¶æ§æ¨¡å¼4ï¼š100%4H 60%2H 30%3H 60%2H 100%1H 0%
  73          void flag_init();
  74          typedef struct
  75          {
  76              u16 b; // å½“å‰äº®åº¦
  77              u8 t;  // å½“å‰äº®åº¦ä¿æŒæ—¶é—´,255æ—¶æ§ç»“æŸ
  78          } t_ctrl_list_t;
  79          
  80          t_ctrl_list_t t_ctrl_lis_0[3] =
  81              {
  82                  {MAX_DUTY, 6}, {_50_DUTY, 6}, {0, 255} // 6 6
  83          };
  84          
  85          t_ctrl_list_t code t_ctrl_lis_1[3] =
  86              {
  87                  {MAX_DUTY, 4}, {_50_DUTY, 8}, {0, 255}};
  88          
  89          t_ctrl_list_t code t_ctrl_lis_2[4] =
  90              {
  91                  {MAX_DUTY, 5}, {_70_DUTY, 3}, {_50_DUTY, 4}, {0, 255} // 534
  92          };
  93          
  94          t_ctrl_list_t code t_ctrl_lis_3[4] =
  95              {
  96                  {MAX_DUTY, 4}, {_70_DUTY, 4}, {_50_DUTY, 4}, {0, 255} // 444
  97          };
  98          
  99          t_ctrl_list_t code t_ctrl_lis_4[6] =
 100              {
 101                  {MAX_DUTY, 4}, {_60_DUTY, 2}, {_30_DUTY, 3}, {_60_DUTY, 2}, {MAX_DUTY, 1}, {0, 255} // 42321
 102          };
 103          
 104          t_ctrl_list_t *p_list;
 105          
 106          extern u16 cap0_val;
 107          extern u16 cap1_val;
 108          
 109          extern void led_pwr_on(void);
 110          extern void cmp_duty(void);
 111          extern void led_plus(void);
 112          extern void led_sub(void);
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 3   

 113          extern void cal_pwm_in_duty(void);
 114          
 115          extern u16 adjust_val; // ç”µä½å™¨çš„ADCå€¼ 0~3686---->60%~100%---->3600~6000
 116          u16 ajust_duty;
 117          // 20æ¡£ç”µä½å™¨è°ƒèŠ‚pwm   60%-62%-64%-66%- 68%-70%-72%-74%-76%6-7896-80%--82. 5%-85%-87.5%-90%-92%-94%-
             -96%-98%-100%
 118          // ä¿®æ”¹ä¸º40æ¡£ç”µä½å™¨è°ƒèŠ‚ pwm
 119          void adjust_pwm()
 120          {
 121   1          static u16 last_level = 0xFF;           // è®°å½•ä¹‹å‰çš„æŒ¡ä½
 122   1          u16 cur_level = adjust_val / LEVLE_PER; // è®¡ç®—å½“å‰æŒ¡ä½
 123   1      
 124   1          if (adjust_en == 1)
 125   1          {
 126   2      #if 0 // 20çº§æŒ¡ä½è°ƒèŠ‚ï¼š
                      if (adjust_val > 3680) // 4.5Vå¯¹åº”çš„ADå€¼
                      {
                          ajust_duty = 6000;
                      }
                      if (0 < adjust_val && adjust_val < LEVLE_PER)
                      {
                          ajust_duty = 3600;
                      }
                      else if (LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 2)
                      {
                          ajust_duty = 3720;
                      }
                      else if (2 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 3)
                      {
                          ajust_duty = 3840;
                      }
                      else if (3 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 4)
                      {
                          ajust_duty = 3960;
                      }
                      else if (4 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 5)
                      {
                          ajust_duty = 4080;
                      }
                      else if (5 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 6)
                      {
                          ajust_duty = 4200;
                      }
                      else if (6 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 7)
                      {
                          ajust_duty = 4320;
                      }
                      else if (7 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 8)
                      {
                          ajust_duty = 4440;
                      }
                      else if (8 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 9)
                      {
                          ajust_duty = 4560;
                      }
                      else if (9 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 10)
                      {
                          ajust_duty = 4680;
                      }
                      else if (10 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 11)
                      {
                          ajust_duty = 4800;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 4   

                      }
                      else if (11 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 12)
                      {
                          ajust_duty = 4950;
                      }
                      else if (12 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 13)
                      {
                          ajust_duty = 5100;
                      }
                      else if (13 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 14)
                      {
                          ajust_duty = 5250;
                      }
                      else if (14 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 15)
                      {
                          ajust_duty = 5400;
                      }
                      else if (15 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 16)
                      {
                          ajust_duty = 5520;
                      }
                      else if (16 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 17)
                      {
                          ajust_duty = 5640;
                      }
                      else if (17 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 18)
                      {
                          ajust_duty = 5760;
                      }
                      else if (18 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 19)
                      {
                          ajust_duty = 5880;
                      }
                      else if (19 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 20)
                      {
                          ajust_duty = 6000;
                      }
                      // ajust_duty=5760;
              #endif
 213   2      
 214   2              if (adjust_val > 3680) // è¶…å‡ºäº†4.5Vå¯¹åº”çš„ADå€¼
 215   2              {
 216   3                  ajust_duty = 6000;
 217   3                  last_level = cur_level;
 218   3                  return;
 219   3              }
 220   2      
 221   2              if (0 == cur_level) // æœ€å°æŒ¡ä½
 222   2              {
 223   3                  ajust_duty = 3600;
 224   3                  last_level = cur_level;
 225   3                  return;
 226   3              }
 227   2      
 228   2              if (cur_level >= ADJUST_STEP) // æœ€å¤§æŒ¡ä½
 229   2              {
 230   3                  ajust_duty = 6000;
 231   3                  last_level = cur_level;
 232   3                  return;
 233   3              }
 234   2      
 235   2              if (last_level == cur_level)
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 5   

 236   2              {
 237   3                  // ä¹‹å‰çš„æŒ¡ä½å’Œå½“å‰è®¡ç®—å¾—å‡ºçš„æŒ¡ä½ä¸€æ ·ï¼Œä¸è°ƒèŠ‚
 238   3                  return;
 239   3              }
 240   2      
 241   2              ajust_duty = 3600 + cur_level * ((6000 - 3600) / ADJUST_STEP);
 242   2              last_level = cur_level;
 243   2          }
 244   1      }
 245          
 246          //
 247          u16 ex_temp_t = 0;    // æ¸©åº¦è®¡æ•°å€¼ï¼Œé¢„è®¡æ¯ç§’åŠ ä¸€
 248          u8 ex_temp_cnt = 0;   // è¿‡æ¸©é™åŠŸç‡å¤„ç†æ¬¡æ•°ï¼Œç¬¬ä¸€æ¬¡é™åˆ°90% ç¬¬äºŒæ¬¡80%-----
 249          u8 ex_temp_state = 1; // æ ‡å¿—ä½ï¼Œæ¸©åº¦æ‰«æçš„åŠä¸ªå°æ—¶æ˜¯å¦åˆ°æ¥
 250          
 251          u16 pwm_save[10] = 0; // æ£€æµ‹æ¸©åº¦æ§åˆ¶ä¸­ï¼Œä½¿ç”¨åˆ°çš„æ•°ç»„
 252          u16 ex_duty = 0; // æ¸©åº¦æ§åˆ¶ä¸­ï¼Œå­˜æ”¾ç»è¿‡æ¸©åº¦é™åˆ¶åï¼Œå¯è°ƒçš„ã€æœ€å¤§çš„pwmå ç©ºæ¯”
 253          bit extemp_flag = 0; // æ ‡å¿—ä½ï¼Œæ˜¯å¦æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­
 254          bit extemp_tctrl_flag = 0;
 255          #if 0
              void ex_temp_adjust_timer() // è¿‡æ¸©é™åŠŸç‡ å®šæ—¶åˆ¤æ–­ æ¯ç§’æ‰§è¡Œä¸€æ¬¡
              {
                  // printf("ntc_val=%d  ex_temp_cnt=%d   ex_temp_t=%d  \r\n",(int)pwm_in_duty,(int)c_duty,(int)ex_temp_
             -t);
                  
                  // å¦‚æœä½¿èƒ½äº†æ¸©åº¦æ£€æµ‹åŠŸèƒ½ å¹¶ä¸” æ—¶æ§åŠŸèƒ½ æœªä½¿èƒ½
                  if (ex_temp_en == 1 && t_ctrl.en == 0) 
                  {
                      // ntc_val=adjust_val;
                      if (extemp_tctrl_flag == 1)
                      {
                          pwm_save[0] = max_duty;
                          ex_temp_cnt = 0;
                          extemp_tctrl_flag = 0;
                      }
              
                      // åŠå°æ—¶å¤„ç†ä¸€æ¬¡ ADå€¼è¶Šå° æ¸©åº¦è¶Šé«˜
                      /*
                          å¦‚æœåŠä¸ªå°æ—¶åˆ°æ¥ï¼Œæ£€æµ‹åˆ°æ¸©åº¦è¿‡å¤§ (æ¸©åº¦è¶Šå¤§ï¼Œæ£€æµ‹åˆ°çš„adå€¼è¶Šå°) 
                      */
                      if (ntc_val < _3_1V && ex_temp_state == 1) 
                      {
                          pwm_save[ex_temp_cnt] = pwm_in_duty; 
              
                          ex_duty = pwm_save[0] - (pwm_save[0] / 10 * (ex_temp_cnt + 1)); // ç¬¬ä¸€æ¬¡é™åˆ°90%ï¼Œä¹‹å
             -æ¯æ¬¡å°†10%
                          ex_temp_state = 0;                                              // å¤„ç†å®Œæˆ åŠå°æ—¶åå†
             -å¼€å¯
                          ex_temp_t = 0; // æ¸…ç©ºæ¸©åº¦æ—¶é—´è®¡æ•°
              
                          max_duty = ex_duty; // æ›´æ–°å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”
                          ex_temp_cnt++; // æ¸©åº¦è¿‡çƒ­æ¬¡æ•°åŠ ä¸€
                          if (ex_temp_cnt > 9)  // å¦‚æœè¿‡çƒ­å¤§äº9æ¬¡ï¼Œå°†å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”è®¾ç½®ä¸º0%
                          {
                              max_duty = 0;
                          }
              
                          extemp_flag = 1; // è¡¨ç¤ºæ£€æµ‹åˆ°äº†æ¸©åº¦è¿‡çƒ­
                      }
              
                      // æ¸©åº¦é™ä¸‹æ¥å ä¸å¹²é¢„æœ€å¤§å€¼ å¹¶ä¸”è®¡æ•°ç½®0 ä¸‹æ¬¡è¿‡æ¸©å†ä»90%å¼€å§‹
                      /*  
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 6   

                          å¦‚æœæ£€æµ‹åˆ°æ¸©åº¦æœ‰ä¸‹é™ï¼Œè¿™é‡Œæ¯ç§’ä¼šè¿›å…¥ä¸€æ¬¡
                      */
                      if (ntc_val > _3_1V) 
                      {
                          ex_temp_cnt = 0;
                          
                          /*
                              å¦‚æœä¹‹å‰æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­ï¼Œå¹¶ä¸”åŠä¸ªå°æ—¶çš„æ‰«æå‘¨æœŸåˆ°æ¥
                          */
                          if (extemp_flag == 1 && ex_temp_state == 1) 
                          {
                              if (extemp_tctrl_flag == 0)
                              {
                                  if (adjust_en == 1)
                                  {
                                      if (_3_1.en == 1)
                                          max_duty = pwm_in_duty_xuwei;
                                      else
                                          max_duty = ajust_duty;
                                  }
              
                                  if (adjust_en == 0)
                                  {
                                      if (_3_1.en == 1)
                                          max_duty = ex_pwm_in_duty;
                                      else
                                          max_duty = pwm_save[0];
                                  }
              
                                  if (P00 == 0)
                                  {
                                      if (max_duty > ex_max_duty)
                                      {
                                          max_duty = ex_max_duty;
                                      }
                                  }
                              }
              
                              if (extemp_tctrl_flag == 1)
                              {
                                  extemp_tctrl_flag = 0;
                                  extemp_flag = 0;
                                  ex_temp_cnt = 0;
                                  return;
                              }
                          }
                      }
              
                      ex_temp_t++;
                      if (ex_temp_t == L_TEMP_PWR_T) // å¦‚æœè¶…è¿‡äº†30åˆ†é’Ÿ
                      {
                          ex_temp_t = 0; // åŠå°æ—¶è®¡æ•°æ¸…é›¶
                          ex_temp_state = 1;
                          // extemp_flag=0;
                      }
              
                      //    if(extemp_tctrl_flag==1)
                      //                      {
                      //                              pwm_save[0]=max_duty;
                      //                      }
                  }
              
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 7   

                  is_pwr_down = 1; // ä½¿èƒ½ç¼“æ…¢å‡é™åŠŸç‡ï¼Œç»™æ ‡å¿—ä½ç½®ä¸€
                  // printf("ex_temp_state=%d\r\n",(int)ex_temp_state);
                  // printf("pwm_in_duty= %d  t= %d  ajust_duty=%d  c_duty=%d adjust_val=%d pwm_save[0]=%d\r\n", (int)pw
             -m_in_duty,(int)t_ctrl.t,(int)ajust_duty,(int)c_duty,(int)adjust_val,(int)pwm_save[0]);
              }
              #endif
 362          
 363          #if 0
              volatile u32 temperature_scan_cnt = 0; // æ¸©åº¦æ‰«ææ—¶é—´è®¡æ•°ï¼Œåœ¨å®šæ—¶å™¨ä¸­ç´¯åŠ 
              volatile u8 temperature_status = 0;// çŠ¶æ€æœºï¼Œè®°å½•å½“å‰æ¸©åº¦çŠ¶æ€
              
              void ex_temp_adjust_timer() // è¿‡æ¸©é™åŠŸç‡ å®šæ—¶åˆ¤æ–­ æ¯ç§’æ‰§è¡Œä¸€æ¬¡
              { 
                  // å¦‚æœä½¿èƒ½äº†æ¸©åº¦æ£€æµ‹åŠŸèƒ½ å¹¶ä¸” æ—¶æ§åŠŸèƒ½ æœªä½¿èƒ½
                  if (ex_temp_en == 1 && t_ctrl.en == 0) 
                  { 
                      if (extemp_tctrl_flag == 1)
                      {
                          pwm_save[0] = max_duty;
                          ex_temp_cnt = 0;
                          extemp_tctrl_flag = 0;
                      }
              
                      // åŠå°æ—¶å¤„ç†ä¸€æ¬¡ ADå€¼è¶Šå° æ¸©åº¦è¶Šé«˜
                      /*
                          å¦‚æœåŠä¸ªå°æ—¶åˆ°æ¥ï¼Œæ£€æµ‹åˆ°æ¸©åº¦è¿‡å¤§ (æ¸©åº¦è¶Šå¤§ï¼Œæ£€æµ‹åˆ°çš„adå€¼è¶Šå°) 
                      */
                      if (ntc_val < _3_1V && ex_temp_state == 1) 
                      {
                          pwm_save[ex_temp_cnt] = pwm_in_duty; 
              
                          ex_duty = pwm_save[0] - (pwm_save[0] / 10 * (ex_temp_cnt + 1)); // ç¬¬ä¸€æ¬¡é™åˆ°90%ï¼Œä¹‹å
             -æ¯æ¬¡å°†10%
                          ex_temp_state = 0;                                              // å¤„ç†å®Œæˆ åŠå°æ—¶åå†
             -å¼€å¯
                          ex_temp_t = 0; // æ¸…ç©ºæ¸©åº¦æ—¶é—´è®¡æ•°
              
                          max_duty = ex_duty; // æ›´æ–°å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”
                          ex_temp_cnt++; // æ¸©åº¦è¿‡çƒ­æ¬¡æ•°åŠ ä¸€
                          if (ex_temp_cnt > 9)  // å¦‚æœè¿‡çƒ­å¤§äº9æ¬¡ï¼Œå°†å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”è®¾ç½®ä¸º0%
                          {
                              max_duty = 0;
                          }
              
                          extemp_flag = 1; // è¡¨ç¤ºæ£€æµ‹åˆ°äº†æ¸©åº¦è¿‡çƒ­
                      }
              
                      if (ntc_val > _3_1V) // æ¸©åº¦é™ä¸‹æ¥å ä¸å¹²é¢„æœ€å¤§å€¼ å¹¶ä¸”è®¡æ•°ç½®0 ä¸‹æ¬¡è¿‡æ¸©å†ä»9
             -0%å¼€å§‹
                      {
                          ex_temp_cnt = 0;
                          
                          /*
                              å¦‚æœä¹‹å‰æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­ï¼Œå¹¶ä¸”åŠä¸ªå°æ—¶çš„æ‰«æå‘¨æœŸåˆ°æ¥
                          */
                          if (extemp_flag == 1 && ex_temp_state == 1) 
                          {
                              if (extemp_tctrl_flag == 0)
                              {
                                  if (adjust_en == 1)
                                  {
                                      if (_3_1.en == 1)
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 8   

                                          max_duty = pwm_in_duty_xuwei;
                                      else
                                          max_duty = ajust_duty;
                                  }
              
                                  if (adjust_en == 0)
                                  {
                                      if (_3_1.en == 1)
                                          max_duty = ex_pwm_in_duty;
                                      else
                                          max_duty = pwm_save[0];
                                  }
              
                                  if (P00 == 0)
                                  {
                                      if (max_duty > ex_max_duty)
                                      {
                                          max_duty = ex_max_duty;
                                      }
                                  }
                              }
              
                              if (extemp_tctrl_flag == 1)
                              {
                                  extemp_tctrl_flag = 0;
                                  extemp_flag = 0;
                                  ex_temp_cnt = 0;
                                  return;
                              }
                          } // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­ï¼Œå¹¶ä¸”åŠä¸ªå°æ—¶çš„æ‰«æå‘¨æœŸåˆ°æ¥
                      }
              
                      // ex_temp_t++;
                      // if (ex_temp_t == L_TEMP_PWR_T) // å¦‚æœè¶…è¿‡äº†30åˆ†é’Ÿ
                      // {
                      //     ex_temp_t = 0; // åŠå°æ—¶è®¡æ•°æ¸…é›¶
                      //     ex_temp_state = 1;
                      // } 
                  }
              
                  is_pwr_down = 1; // ä½¿èƒ½ç¼“æ…¢å‡é™åŠŸç‡ï¼Œç»™æ ‡å¿—ä½ç½®ä¸€ 
              }
              #endif
 458          
 459          void set_pwm_duty(void)
 460          {
 461   1          u16 duty_tmp;
 462   1          //    if(c_duty != 0)
 463   1          {
 464   2      
 465   2              duty_tmp = MAX_DUTY - c_duty;
 466   2              // c_duty = 10;
 467   2              STMR0_CMPAH = STMR_CMPA_VAL_H(((c_duty) >> 8) & 0xFF); // æ¯”è¾ƒå€¼
 468   2              STMR0_CMPAL = STMR_CMPA_VAL_L(((c_duty) >> 0) & 0xFF); // æ¯”è¾ƒå€¼
 469   2              STMR_LOADEN |= STMR_0_LOAD_EN(0x1);                    // è‡ªåŠ¨è£…è½½ä½¿èƒ½
 470   2          }
 471   1          //    else
 472   1          {
 473   2          }
 474   1      
 475   1          // TMR2_PWMH  = TMR_PWM_VAL_H((duty_tmp >> 8) & 0xFF);                      // å ç©ºæ¯”è®¾ç½®å€¼
 476   1          // TMR2_PWML  = TMR_PWM_VAL_L((duty_tmp >> 0) & 0xFF);
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 9   

 477   1      }
 478          
 479          u8 adjust_ms = 0;
 480          void cap_timer(void)
 481          {
 482   1          if (cap_10ms_cnt < 10)
 483   1          {
 484   2              cap_10ms_cnt++;
 485   2          }
 486   1          pwr_on_cnt++;
 487   1          adjust_ms++;
 488   1      }
 489          
 490          // æ”¾åœ¨while,æ²¡10msè·å–ä¸€æ¬¡PWMå ç©ºæ¯”
 491          // è¿ç»­è·å–5æ¬¡ï¼Œå ç©ºæ¯”ç¨³å®šæ‰è¾“å‡º
 492          u16 duty_buff[5];
 493          u8 duty_cnt = 0;
 494          // ä¸Šç”µé‡‡æ ·5æ¬¡å®Œæˆæ ‡å¿—ä¸º
 495          u8 simple_over = 0;
 496          // æ”¾ä¸»å¾ªç¯
 497          void get_duty(void)
 498          {
 499   1          // 10msè·å–ä¸€æ¬¡
 500   1          if (cap_10ms_cnt >= 10)
 501   1          {
 502   2              cap_10ms_cnt = 0;
 503   2              if (_3_1.en == 1) // ä¸‰åˆä¸€åŠŸèƒ½å¼€å¯æ‰è°ƒå…‰
 504   2              {
 505   3                  // éä¸‰åˆä¸€ä¸ä¼šæ›´æ–°pwm_in_duty
 506   3                  cal_pwm_in_duty();
 507   3              }
 508   2              // å¤„ç†é™åŠŸç‡ï¼Œæ—¶æ§æ¿€æ´»ï¼Œé™åˆ¶å¯è°ƒçš„å ç©ºæ¯”èŒƒå›´
 509   2              // å»¶æ—¶å¼€æœºæ¨¡å¼ï¼Œå¼ºåˆ¶pwm_in_duty=0
 510   2      
 511   2              pwm_in_handler();
 512   2              cmp_duty();
 513   2          }
 514   1      
 515   1          if (adjust_ms == 3)
 516   1          {
 517   2              adjust_ms = 0;
 518   2              led_plus();
 519   2              led_sub();
 520   2          }
 521   1      
 522   1          led_pwr_on();
 523   1      }
 524          
 525          // è®¡ç®—ä¸‰åˆä¸€çš„å ç©ºæ¯”,å‚¨å­˜pwm_in_duty
 526          void cal_pwm_in_duty(void)
 527          {
 528   1          u8 i;
 529   1          if (cap1_val == 0 && cap0_val == 0)
 530   1          {
 531   2              if (P14 == 0)
 532   2              {
 533   3                  // å ç©ºæ¯” 0
 534   3                  pwm_in_duty = 0;
 535   3              }
 536   2              if (P14 == 1)
 537   2              {
 538   3                  pwm_in_duty = 6000;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 10  

 539   3              }
 540   2          }
 541   1          else
 542   1          {
 543   2              pwm_in_duty = (u32)MAX_DUTY * (cap1_val + 1);
 544   2              pwm_in_duty = pwm_in_duty / (cap0_val + 1);
 545   2          }
 546   1      
 547   1          cap1_val = 0;
 548   1          cap0_val = 0;
 549   1          duty_buff[duty_cnt] = pwm_in_duty;
 550   1          duty_cnt++;
 551   1          if (duty_cnt == 5)
 552   1          {
 553   2              simple_over = 1;
 554   2              duty_cnt = 0;
 555   2          }
 556   1          if (simple_over == 1)
 557   1          {
 558   2              pwm_in_duty = 0;
 559   2              for (i = 0; i < 5; i++)
 560   2              {
 561   3                  pwm_in_duty += duty_buff[i];
 562   3              }
 563   2              // æ±‚å¹³å‡
 564   2              pwm_in_duty = pwm_in_duty / 5;
 565   2          }
 566   1          // printf("3_1_pwm_in_duty= %d    c_duty=%d\r\n",(int)pwm_in_duty,(int)c_duty);
 567   1          // pwm_in_duty=5000;
 568   1      
 569   1          if (adjust_en == 1)
 570   1          {
 571   2              pwm_in_duty_xuwei = pwm_in_duty * ajust_duty / 6000;
 572   2              pwm_in_duty = pwm_in_duty_xuwei;
 573   2          }
 574   1          ex_pwm_in_duty = pwm_in_duty;
 575   1      }
 576          
 577          // å¯¹æ¯”å½“å‰çš„dutyæ˜¯å¦å‘ç”Ÿå˜åŒ–
 578          void cmp_duty(void)
 579          {
 580   1          if (led_state == LED_PWR_ON)
 581   1              return;
 582   1      
 583   1          if (pwm_in_duty > 10)
 584   1          {
 585   2              if ((pwm_in_duty - 10) > c_duty)
 586   2              {
 587   3                  led_state = LED_ADJ_P;
 588   3              }
 589   2              if ((pwm_in_duty + 10) < c_duty)
 590   2              {
 591   3                  led_state = LED_ADJ_S;
 592   3              }
 593   2          }
 594   1          else
 595   1          {
 596   2              if (pwm_in_duty > c_duty)
 597   2              {
 598   3                  led_state = LED_ADJ_P;
 599   3              }
 600   2              if (pwm_in_duty < c_duty)
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 11  

 601   2              {
 602   3                  led_state = LED_ADJ_S;
 603   3              }
 604   2          }
 605   1      }
 606          
 607          // ä¸Šç”µledç¼“æ…¢å¯åŠ¨
 608          // æ¯10msæ‰§è¡Œä¸€æ¬¡ï¼Œc_dutyæ¯æ¬¡+30
 609          float gamma = 1;
 610          void debug_putchar(u8 uart_data);
 611          
 612          // float step = 90;
 613          float step = 70;
 614          
 615          float mi;  // å¹‚
 616          float rus; // 10çš„å¹‚æ¬¡æ–¹
 617          float r_ms = 0;
 618          u16 rus_duty; // æ”¾å¤§60å€
 619          
 620          // 1msè°ƒç”¨ä¸€æ¬¡     LIN æ”¹ åŠ å…¥ç”µä½å™¨åˆ¤æ–­
 621          void led_pwr_on(void)
 622          {
 623   1          if (led_state == LED_PWR_ON && simple_over == 1)
 624   1          {
 625   2              // æ²¡æœ‰ç”µä½å™¨æ—¶
 626   2              // æ²¡æœ‰ä¸‰åˆä¸€åŠŸèƒ½ï¼Œä¸Šç”µé»˜è®¤æœ€å¤§å ç©ºæ¯”
 627   2              //  æœ‰ä¸‰åˆä¸€åŠŸèƒ½ï¼ŒæŒ‰é‡‡ç”¨çš„å ç©ºæ¯”è°ƒå…‰
 628   2              if (adjust_en == 0)
 629   2              {
 630   3                  if (_3_1.en == 0)
 631   3                  {
 632   4                      pwm_in_duty = max_duty;
 633   4                  }
 634   3                  r_ms = step / 12;
 635   3                  if (r_ms < 1)
 636   3                      r_ms = 10;
 637   3                  if (pwr_on_cnt < r_ms)
 638   3                      return; // æ—¶é—´æœªåˆ°ä¸è°ƒæ•´
 639   3                  pwr_on_cnt = 0;
 640   3                  if (c_duty < pwm_in_duty)
 641   3                  {
 642   4                      mi = (step - 1) / (253 / 3) - 1;
 643   4                      step += 0.5;
 644   4                      c_duty = pow(5, mi) * 60;
 645   4                  }
 646   3                  if (c_duty >= pwm_in_duty)
 647   3                  {
 648   4                      c_duty = pwm_in_duty;
 649   4                      led_state = LED_NULL;
 650   4                  }
 651   3                  set_pwm_duty();
 652   3              }
 653   2              if (adjust_en == 1) // æœ‰æ²¡æœ‰ä¸‰åˆä¸€åŠŸèƒ½ï¼Œä¸Šç”µéƒ½é»˜è®¤ç”µä½å™¨çš„æœ€å¤§å ç©ºæ¯”
 654   2              {
 655   3                  if (_3_1.en == 0)
 656   3                  {
 657   4                      pwm_in_duty = ajust_duty;
 658   4                  }
 659   3                  if (_3_1.en == 1)
 660   3                  {
 661   4                      pwm_in_duty = pwm_in_duty_xuwei;
 662   4                  }
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 12  

 663   3                  {
 664   4                      r_ms = step / 12;
 665   4                      if (r_ms < 1)
 666   4                          r_ms = 10;
 667   4                      if (pwr_on_cnt < r_ms)
 668   4                          return; // æ—¶é—´æœªåˆ°ä¸è°ƒæ•´
 669   4                      pwr_on_cnt = 0;
 670   4                      if (c_duty < pwm_in_duty)
 671   4                      {
 672   5                          mi = (step - 1) / (253 / 3) - 1;
 673   5                          step += 0.5;
 674   5                          c_duty = pow(5, mi) * 60;
 675   5                      }
 676   4                      if (c_duty >= pwm_in_duty)
 677   4                      {
 678   5                          c_duty = pwm_in_duty;
 679   5                          led_state = LED_NULL;
 680   5                      }
 681   4                      set_pwm_duty();
 682   4                  }
 683   3              }
 684   2          }
 685   1          // printf("pwm_in_duty= %d   t= %d    t_ctrl.level=%d    c_duty=%d\r\n", (int)pwm_in_duty,(int)t_ctrl.
             -t,(int)ajust_duty,(int)c_duty);
 686   1      }
 687          
 688          void led_plus(void)
 689          {
 690   1          if (led_state != LED_ADJ_P)
 691   1              return;
 692   1          if (c_duty < pwm_in_duty)
 693   1          {
 694   2              if (is_pwr_down) // ç¼“æ…¢å‡é™
 695   2                  c_duty += 1;
 696   2              else
 697   2                  c_duty += 10;
 698   2          }
 699   1      
 700   1          if (c_duty >= pwm_in_duty)
 701   1          {
 702   2              c_duty = pwm_in_duty;
 703   2              led_state = LED_NULL;
 704   2              gamma = c_duty;
 705   2              is_pwr_down = 0; // å®Œæˆç¼“æ…¢å‡é™
 706   2          }
 707   1          set_pwm_duty();
 708   1      }
 709          
 710          void led_sub(void)
 711          {
 712   1          if (led_state != LED_ADJ_S)
 713   1              return;
 714   1      
 715   1          if (c_duty > pwm_in_duty)
 716   1          {
 717   2              if (is_pwr_down)
 718   2                  c_duty -= 1;
 719   2              else
 720   2              {
 721   3                  if (c_duty > 50)
 722   3                  {
 723   4      
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 13  

 724   4                      c_duty -= 10;
 725   4                  }
 726   3                  else
 727   3                  {
 728   4                      c_duty -= 1;
 729   4                  }
 730   3              }
 731   2          }
 732   1          if (c_duty <= pwm_in_duty)
 733   1          {
 734   2              c_duty = pwm_in_duty;
 735   2              gamma = c_duty;
 736   2              is_pwr_down = 0; // å®Œæˆç¼“æ…¢å‡é™
 737   2              led_state = LED_NULL;
 738   2          }
 739   1          set_pwm_duty();
 740   1      }
 741          
 742          // æœ‰æ²¡æœ‰é™åŠŸç‡
 743          #define LOW_PWR_R7 P00
 744          // æœ‰æ²¡æœ‰ä¸‰åˆä¸€
 745          #define _3_1_R14 P02
 746          // æœ‰æ²¡æœ‰æ—¶ç©º
 747          #define T_C_R11 P03
 748          
 749          #define T_C_R8 P13
 750          #define T_C_R9 P12
 751          #define T_C_R10 P11
 752          
 753          // é™åŠŸç‡ã€æ—¶ç©ºã€ä¸‰åˆä¸€åŠŸèƒ½
 754          void option_fun(void)
 755          {
 756   1          flag_init();
 757   1          // p13è¾“å…¥ä¸Šæ‹‰ï¼Œæ—¶ç©ºç»„åˆR8
 758   1          P1_MD0 &= ~(GPIO_P13_MODE_SEL(0x3));
 759   1          P1_PU |= (GPIO_P13_PULL_UP(0x1));
 760   1          P1_PD |= (GPIO_P13_PULL_PD(1));
 761   1          //   æ—¶ç©ºç»„åˆR9
 762   1          P1_MD0 &= ~(GPIO_P12_MODE_SEL(0x3));
 763   1          P1_PU |= (GPIO_P12_PULL_UP(0x1));
 764   1          // æ—¶ç©ºç»„åˆR10
 765   1          P1_MD0 &= ~(GPIO_P11_MODE_SEL(0x3));
 766   1          P1_PU |= (GPIO_P11_PULL_UP(0x1));
 767   1          // é™åŠŸç‡æœ‰/æ—  R7
 768   1          P0_MD0 &= ~(GPIO_P00_MODE_SEL(0x3));
 769   1          P0_PU |= (GPIO_P00_PULL_UP(0x1));
 770   1          // ä¸‰åˆä¸€æœ‰/æ—  R14
 771   1          P0_MD0 &= ~(GPIO_P02_MODE_SEL(0x3));
 772   1          P0_PU |= (GPIO_P02_PULL_UP(0x1));
 773   1          // æ—¶ç©ºæœ‰/æ—  R11
 774   1          P0_MD0 &= ~(GPIO_P03_MODE_SEL(0x3));
 775   1          P0_PU |= (GPIO_P03_PULL_UP(0x1));
 776   1      
 777   1          if (LOW_PWR_R7 == 0) // ä½ç”µå¹³æœ‰é™åŠŸç‡
 778   1          {
 779   2              l_pwr.en = 1;
 780   2              printf("l_pwr.en = 1\r\n");
 781   2          }
 782   1          else
 783   1          {
 784   2              l_pwr.en = 0;
 785   2              printf("l_pwr.en = 0\r\n");
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 14  

 786   2          }
 787   1          if (adc0_val > 4000) // LIN æ”¹ åŠ å…¥äº†ntcå’Œç”µä½å™¨ADå€¼çš„åˆ¤æ–­ ntcå’Œç”µä½å™¨éƒ½ä¸Šæ‹‰
 788   1          {
 789   2              ex_temp_en = 0; // ä¸ä½¿èƒ½ æ¸©åº¦æ£€æµ‹ åŠŸèƒ½
 790   2              printf("ex_temp_en = 0\r\n");
 791   2          }
 792   1          else
 793   1          {
 794   2              ex_temp_en = 1; // ä½¿èƒ½ æ¸©åº¦æ£€æµ‹ åŠŸèƒ½
 795   2              printf("ex_temp_en = 1\r\n");
 796   2          }
 797   1          if (adc1_val > 4000)
 798   1          {
 799   2              adjust_en = 0;
 800   2              printf("adjust_en = 0\r\n");
 801   2          }
 802   1          else
 803   1          {
 804   2              adjust_en = 1;
 805   2              printf("adjust_en = 1\r\n");
 806   2          }
 807   1          if (_3_1_R14 == 1) // é«˜ç”µå¹³æœ‰ä¸‰åˆä¸€
 808   1          {
 809   2              _3_1.en = 1;
 810   2              // simple_over = 1;
 811   2              printf("_3_1.en  = 1\r\n");
 812   2          }
 813   1          else
 814   1          {
 815   2              _3_1.en = 0;
 816   2              simple_over = 1;
 817   2              printf("_3_1.en  = 0\r\n");
 818   2          }
 819   1      
 820   1          // ä½ç”µå¹³ä½¿èƒ½ æ—¶æ§
 821   1          if (T_C_R11 == 0) //  0
 822   1          {
 823   2              t_ctrl.en = 1;
 824   2              printf("t_ctrl.en = 1\r\n");
 825   2          }
 826   1          else
 827   1          {
 828   2              t_ctrl.en = 0;
 829   2              printf("t_ctrl.en = 0\r\n");
 830   2          }
 831   1      
 832   1          // æ—¶æ§æ¨¡å¼0ï¼š100%6H 50%6H 0%
 833   1          // æ—¶æ§æ¨¡å¼1ï¼š100%4H 50%8H 0%
 834   1          // æ—¶æ§æ¨¡å¼2ï¼š100%5H 70%3H 50%4H 0%
 835   1          // æ—¶æ§æ¨¡å¼3ï¼š100%4H 70%4H 50%4H 0%
 836   1          // æ—¶æ§æ¨¡å¼4ï¼š100%4H 60%2H 30%3H 60%2H 100%1H 0%
 837   1      
 838   1          if (T_C_R8 == 1 && T_C_R9 == 1 && T_C_R10 == 1)
 839   1          {
 840   2              t_ctrl.list = 0;
 841   2              p_list = &t_ctrl_lis_0;
 842   2              printf("t_ctrl.list = 0 \r\n");
 843   2          }
 844   1          else if (T_C_R8 == 0 && T_C_R9 == 1 && T_C_R10 == 1)
 845   1          {
 846   2              t_ctrl.list = 1;
 847   2              p_list = &t_ctrl_lis_1;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 15  

 848   2              printf("t_ctrl.list = 1\r\n ");
 849   2          }
 850   1          else if (T_C_R8 == 1 && T_C_R9 == 0 && T_C_R10 == 1)
 851   1          {
 852   2              t_ctrl.list = 2;
 853   2              p_list = &t_ctrl_lis_2;
 854   2              printf("t_ctrl.list = 2\r\n ");
 855   2          }
 856   1          else if (T_C_R8 == 1 && T_C_R9 == 1 && T_C_R10 == 0)
 857   1          {
 858   2              t_ctrl.list = 3;
 859   2              p_list = &t_ctrl_lis_3;
 860   2              printf("t_ctrl.list = 3\r\n ");
 861   2          }
 862   1          else if (T_C_R8 == 0 && T_C_R9 == 0 && T_C_R10 == 1)
 863   1          {
 864   2              t_ctrl.list = 4;
 865   2              p_list = &t_ctrl_lis_4;
 866   2              printf("t_ctrl.list = 4\r\n");
 867   2          }
 868   1      }
 869          
 870          // é™åŠŸç‡è®¡æ—¶å¤„ç†
 871          void l_pwr_timer_handler(void)
 872          {
 873   1          if (l_pwr.en == 1)
 874   1          {
 875   2              if (l_pwr.t < L_PWR_T) // å°æ—¶
 876   2              {
 877   3                  l_pwr.t++;
 878   3              }
 879   2              else
 880   2              {
 881   3                  // å¤§äº1å°æ—¶
 882   3      
 883   3                  extemp_tctrl_flag = 1;
 884   3                  if (adjust_en == 1) // ç”µä½å™¨ä½¿èƒ½
 885   3                  {
 886   4                      if (_3_1.en == 1) // æœ‰ä¸‰åˆä¸€åŠŸèƒ½å’Œç”µä½å™¨
 887   4                      {
 888   5                          // åˆ¤æ–­PWM_inå ç©ºæ¯”å¤§äº74
 889   5                          if (pwm_in_duty_xuwei > ajust_duty / 100 * 75) // LIN æ”¹  75%æ”¹æˆç”µä½å™¨çš„75%
 890   5                          {
 891   6                              max_duty = ajust_duty / 100 * 75;
 892   6                              l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 893   6                              l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 894   6                              is_pwr_down = 1;
 895   6                          }
 896   5                      }
 897   4                      else
 898   4                      {
 899   5                          max_duty = ajust_duty / 100 * 75;
 900   5                          l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 901   5                          l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 902   5                          is_pwr_down = 1;
 903   5                      }
 904   4                  }
 905   3      
 906   3                  if (adjust_en == 0) // æ— ç”µä½å™¨
 907   3                  {
 908   4                      if (_3_1.en) // æœ‰ä¸‰åˆä¸€åŠŸèƒ½
 909   4                      {
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 16  

 910   5                          // åˆ¤æ–­PWM_inå ç©ºæ¯”å¤§äº74
 911   5                          if (pwm_in_duty > _75_DUTY)
 912   5                          {
 913   6                              max_duty = _75_DUTY;
 914   6                              l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 915   6                              l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 916   6                              is_pwr_down = 1;
 917   6                          }
 918   5                      }
 919   4                      else
 920   4                      {
 921   5                          max_duty = _75_DUTY;
 922   5                          l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 923   5                          l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 924   5                          is_pwr_down = 1;
 925   5                      }
 926   4                  }
 927   3                  l_pwr.en = 0;
 928   3                  ex_max_duty = max_duty;
 929   3              }
 930   2          }
 931   1      }
 932          
 933          // å¤„ç†é™åŠŸç‡ï¼Œæ—¶æ§æ—¶ï¼Œå¯è°ƒçš„å ç©ºæ¯”èŒƒå›´
 934          // å»¶æ—¶å¼€æœºæ¨¡å¼ï¼Œå¼ºåˆ¶pwm_in_duty=0
 935          void pwm_in_handler(void)
 936          {
 937   1          // if(_3_1.en)     //æœ‰ä¸‰åˆä¸€åŠŸèƒ½
 938   1          {
 939   2              // æ—¶æ§å’Œé™åŠŸç‡æ¿€æ´»çŠ¶æ€ï¼Œæœ€å¤§å ç©ºæ¯”ä¸è¶…è¿‡é™åŠŸç‡ï¼Œæ—¶æ§, LIN æ”¹ è¿‡æ¸©é™å
             -ŠŸç‡è®¾å®šçš„å ç©ºæ¯”
 940   2              //                      if(t_ctrl.en == 1)
 941   2              //                      {
 942   2              //                              if(_3_1.en==1)
 943   2              //                {
 944   2              //                    pwm_in_duty = pwm_in_duty;
 945   2              //                }
 946   2              //
 947   2              //                              if(adjust_en==1)
 948   2              //                              {
 949   2              //                                      pwm_in_duty = ajust_duty;
 950   2              //                              }
 951   2              //                              if(_3_1.en==0&&adjust_en==0)
 952   2              //                              {
 953   2              //                                      pwm_in_duty = max_duty;
 954   2              //                              }
 955   2              //                      }
 956   2              if (t_ctrl.en == 0 && adjust_en == 1)
 957   2              {
 958   3                  if (_3_1.en == 1)
 959   3                  {
 960   4                      pwm_in_duty = pwm_in_duty_xuwei;
 961   4                  }
 962   3                  else
 963   3                  {
 964   4                      pwm_in_duty = ajust_duty;
 965   4                  }
 966   3              }
 967   2              if (l_pwr.act == 1 || t_ctrl.en == 1)
 968   2              {
 969   3                  // è¿›å…¥é™åŠŸç‡æ¨¡å¼
 970   3      
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 17  

 971   3                  if (adjust_en == 1 && _3_1.en == 1)
 972   3                  {
 973   4      
 974   4                      if (pwm_in_duty_xuwei > max_duty)
 975   4                      {
 976   5                          pwm_in_duty_xuwei = max_duty;
 977   5                      }
 978   4                      pwm_in_duty = pwm_in_duty_xuwei;
 979   4                  }
 980   3                  else
 981   3                  {
 982   4                      if (pwm_in_duty > max_duty)
 983   4                      {
 984   5                          pwm_in_duty = max_duty;
 985   5                      }
 986   4                  }
 987   3              }
 988   2              if (ex_temp_en == 1 && t_ctrl.en == 0)
 989   2              {
 990   3                  if (adjust_en == 0 && _3_1.en == 0)
 991   3                  {
 992   4                      pwm_in_duty = max_duty;
 993   4                  }
 994   3                  if (pwm_in_duty > max_duty)
 995   3                  {
 996   4                      pwm_in_duty = max_duty;
 997   4                  }
 998   3                  if (max_duty == 0)
 999   3                  {
1000   4                      pwm_in_duty = 0;
1001   4                  }
1002   3              }
1003   2          }
1004   1          // is_pwr_down=0;
1005   1          //    if(dly_pwr_on == 1)
1006   1          //    {
1007   1          //        // å»¶æ—¶å¯åŠ¨ï¼Œå¼ºåˆ¶pwm 0
1008   1          //        pwm_in_duty = 0;
1009   1          //    }
1010   1      }
1011          
1012          // 1sè°ƒç”¨ä¸€æ¬¡
1013          void t_ctrl_timer_handler(void)
1014          {
1015   1          if (t_ctrl.en == 1)
1016   1      
1017   1          {
1018   2              // å½“å‰åˆ—è¡¨æ—¶é—´é255ï¼Œå¦‚æœæ˜¯255åˆ™è¯´æ˜æ—¶ç©ºç»“æŸ
1019   2              if (p_list[t_ctrl.level].t != 255)
1020   2              {
1021   3                  //                  t_ctrl.list = 4;
1022   3                  //        p_list = &t_ctrl_lis_4;
1023   3                  t_ctrl.t++;
1024   3                  if (t_ctrl.t >= (p_list[t_ctrl.level].t * 60 * 60)) // æ”¹æˆ10s
1025   3                  // if(t_ctrl.t >= (p_list[t_ctrl.level].t * 10) )
1026   3                  {
1027   4                      t_ctrl.level++;
1028   4                      is_pwr_down = 1;
1029   4                      t_ctrl.t = 0;
1030   4                      max_duty = p_list[t_ctrl.level].b;
1031   4                      extemp_tctrl_flag = 1;
1032   4                      if (adjust_en == 1) // LIN æ”¹ åŠ å…¥ç”µä½å™¨æ—¶ å°†æœ€å¤§å€¼å˜æˆç”µä½å™¨çš„æœ€å¤§å€¼
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 18  

1033   4                      {
1034   5                          switch (max_duty)
1035   5                          {
1036   6                          case 6000:
1037   6                              max_duty = ajust_duty;
1038   6                              break;
1039   6                          case 4200:
1040   6                              max_duty = ajust_duty / 10 * 7;
1041   6                              break;
1042   6                          case 3600:
1043   6                              max_duty = ajust_duty / 10 * 6;
1044   6                              break;
1045   6                          case 3000:
1046   6                              max_duty = ajust_duty / 2;
1047   6                              break;
1048   6                          case 1800:
1049   6                              max_duty = ajust_duty / 10 * 3;
1050   6                              break;
1051   6                          default:
1052   6                              break;
1053   6                          }
1054   5                      }
1055   4                      if (_3_1.en == 1 && ex_temp_en == 1 && t_ctrl.en == 0)
1056   4                      {
1057   5                          //  if(adjust_en==0)
1058   5                          {
1059   6                              if (ex_pwm_in_duty < max_duty)
1060   6                              {
1061   7                                  max_duty = ex_pwm_in_duty;
1062   7                              }
1063   6                          }
1064   5                          //                                                          else
1065   5                          //                                                          {
1066   5                          //                                                                  if(pwm_in_duty_xuwei<max_duty)
1067   5                          //                                                                  {
1068   5                          //                                                                          max_duty=pwm_in_duty_xuwei;
1069   5                          //                                                                  }
1070   5                          //                                                          }
1071   5                      }
1072   4                      pwm_in_duty = max_duty; // ä¿®å¤t_ctrl_lis_4ï¼ŒåŠŸç‡é™åˆ°30%å‡ä¸äº†60%
1073   4                      if (adjust_en == 1 && _3_1.en == 1)
1074   4                      {
1075   5                          pwm_in_duty_xuwei = max_duty;
1076   5                      }
1077   4                  }
1078   3              }
1079   2      
1080   2              //                              if(p_list[t_ctrl.level].t != 0)
1081   2              //                              {
1082   2              //                                      t_ctrl.level=0;
1083   2              //                              }
1084   2              // is_pwr_dow=0;
1085   2          }
1086   1          // printf("pwm_in_duty= %d  t= %d  ajust_duty=%d  max_duty=%d adjust_val=%d pwm_save[0]=%d\r\n", (int)
             -pwm_in_duty,(int)t_ctrl.t,(int)ajust_duty,(int)c_duty,(int)adjust_val,(int)pwm_save[0]);
1087   1          // printf("pwm_in_duty= %d   t= %d    t_ctrl.level=%d    c_duty=%d\r\n", (int)pwm_in_duty,(int)t_ctrl.
             -t,(int)ajust_duty,(int)c_duty);
1088   1      }
1089          
1090          // 1ç§’è°ƒç”¨ä¸€æ¬¡
1091          extern u8 lvd_mode;
1092          extern volatile u8 lvd_flag;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 19  

1093          void dly_pwr_on_handler(void)
1094          {
1095   1          if (dly_pwr_on == 1) // å»¶æ—¶å¯åŠ¨
1096   1          {
1097   2              user_printf("lvd pwr low \n");
1098   2              dly_pwr_on_cnt++;
1099   2              if (dly_pwr_on_cnt >= 5)
1100   2              {
1101   3                  // åˆå§‹åŒ–å…¨å±€å˜é‡ï¼š
1102   3                  lvd_flag = 0;
1103   3                  dly_pwr_on_cnt = 0;
1104   3      
1105   3                  dly_pwr_on = 0;
1106   3      
1107   3                  c_duty = 0;
1108   3                  max_duty = MAX_DUTY;
1109   3      
1110   3                  t_ctrl.list = 0;
1111   3                  t_ctrl.t = 0;
1112   3                  t_ctrl.en = 0;
1113   3                  t_ctrl.level = 0;
1114   3      
1115   3                  l_pwr.en = 0;
1116   3                  l_pwr.act = 0;
1117   3                  l_pwr.t = 0;
1118   3      
1119   3                  _3_1.en = 0;
1120   3                  pwm_in_duty = 0;
1121   3                  ex_temp_en = 0;
1122   3                  adjust_en = 0;
1123   3                  gamma = 2;
1124   3                  option_fun();
1125   3      
1126   3                  led_state = LED_PWR_ON;
1127   3                  printf("LED_PWR_ON");
1128   3              }
1129   2          }
1130   1      }
1131          
1132          // åˆå§‹åŒ–å…¨å±€å˜é‡
1133          void flag_init()
1134          {
1135   1          lvd_flag = 0;
1136   1          dly_pwr_on_cnt = 0;
1137   1      
1138   1          dly_pwr_on = 0;
1139   1      
1140   1          c_duty = 0;
1141   1          max_duty = MAX_DUTY;
1142   1      
1143   1          t_ctrl.list = 0;
1144   1          t_ctrl.t = 0;
1145   1          t_ctrl.en = 0;
1146   1          t_ctrl.level = 0;
1147   1      
1148   1          l_pwr.en = 0;
1149   1          l_pwr.act = 0;
1150   1          l_pwr.t = 0;
1151   1      
1152   1          _3_1.en = 0;
1153   1          pwm_in_duty = 0;
1154   1          ex_temp_en = 0;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          06/13/2025 15:15:03 PAGE 20  

1155   1          adjust_en = 0;
1156   1          gamma = 2;
1157   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3560    ----
   CONSTANT SIZE    =    328    ----
   XDATA SIZE       =    112       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      6    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
