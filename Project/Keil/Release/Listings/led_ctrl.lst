C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE LED_CTRL
OBJECT MODULE PLACED IN .\Release\Objects\led_ctrl.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\led_ctrl.c LARGE OPTIMIZE(8,SPEED) BROWSE INTVECTOR(0X000C) I
                    -NCDIR(..\..\Libraries\Include;..\..\User) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\Listings\led_ctrl.lst) OBJECT(.
                    -\Release\Objects\led_ctrl.obj)

line level    source

   1          #include "include.h"
   2          #include "main.h"
   3          #include <math.h>
   4          #include <stdio.h>
   5          
   6          #include "user_config.h"
   7          
   8          #include "led_ctrl.h"
   9          #include "adc.h"
  10          
  11          
  12          
  13          
  14          
  15          extern void pwm_in_handler(void);
  16          
  17          
  18          
  19          
  20          bit ex_temp_en; // è¿‡æ¸©é™åŠŸç‡æ ‡å¿—ä½
  21          // #define L_PWR_T     (1*10)
  22          
  23          /* LIN æ”¹çš„åœ°æ–¹æœ‰ï¼š
  24                           å¢åŠ adc.cæ–‡ä»¶
  25                           åŠ å…¥äº†ç”µä½å™¨å€¼çš„åˆ¤æ–­                void adjust_pwm()
  26                           åŠ å…¥äº†è¿‡æ¸©é™åŠŸç‡å‡½æ•°                ex_temp_adjust_timer()
  27                                           LIN æ”¹ åŠ å…¥äº†ç”µä½å™¨ å°†æ—¶æ§æ•°å€¼æ”¹åŠ¨  void t_ctrl_timer_handl
             -er(void)
  28                                           åŠ å…¥äº†ntcå’Œç”µä½å™¨çš„è°ƒèŠ‚æ ‡å¿—ä½åˆ¤æ–­   option_fun(void)
  29                                           ä¸€å°æ—¶é™åŠŸç‡ä¸­åŠ å…¥äº†ç”µä½å™¨å€¼è½¬æ¢    l_pwr_timer_handler(v
             -oid)
  30                                           ç¼“å¯åŠ¨æ— ä¸‰åˆä¸€æ—¶å°†æœ€å¤§äº®åº¦æ”¹ä¸ºç”µä½å™¨çš„å€¼   void led_p
             -wr_on(void)
  31          */
  32          typedef struct
  33          {
  34              u32 t;    // è®¡æ—¶å™¨
  35              u8 level; // æ—¶ç©ºåˆ—è¡¨æ‰§è¡Œçš„å“ªä¸€ä¸ªæ—¶é—´æ®µ
  36              u8 list;  // æ—¶æ§åˆ—è¡¨ï¼Œ5ä¸ªåˆ—è¡¨
  37              u8 en;    // ä½¿èƒ½
  38          } t_ctrl_t;   // æ—¶æ§ç»“æ„ä½“
  39          
  40          typedef struct
  41          {
  42              u8 en;
  43              u8 act; // åŠ¨ä½œï¼Œæ‰§è¡Œé™åŠŸç‡åŠ¨ä½œï¼š1
  44              u32 t;  // ç§’
  45          
  46          } l_pwr_t; // é™åŠŸç‡ç»“æ„ä½“
  47          
  48          typedef struct
  49          {
  50              u8 en;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 2   

  51          } _3_1_t; // ä¸‰åˆä¸€ç»“æ„ä½“
  52          
  53          u8 cap_10ms_cnt; // 10msè·å–ä¸€æ¬¡æ•è·å ç©ºæ¯”
  54          u8 pwr_on_cnt;
  55          u16 c_duty = 0;      // å½“å‰è®¾ç½®çš„å ç©ºæ¯”
  56          u32 pwm_in_duty = 0; // ä¸‰åˆä¸€PWMè¾“å…¥çš„å ç©ºæ¯”
  57          u32 pwm_in_duty_xuwei = 0;
  58          u32 ex_pwm_in_duty = 0;
  59          u16 ex_max_duty = 0;
  60          u16 max_duty = 6000; // å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”
  61          t_ctrl_t t_ctrl;
  62          l_pwr_t l_pwr;
  63          _3_1_t _3_1;
  64          bit dly_pwr_on = 0;
  65          u8 dly_pwr_on_cnt = 0;
  66          // 1ï¼šæ­£åœ¨é™åŠŸç‡ï¼Œè°ƒç”¨ç¼“å‡ç¼“é™é€»è¾‘
  67          /*
  68              ç¼“æ…¢å‡é™åŠŸç‡æ˜¯å¦ä½¿èƒ½çš„æ ‡å¿—ä½ï¼Œ0--ä¸ä½¿èƒ½ï¼Œ1--ä½¿èƒ½
  69          */
  70          bit is_pwr_down = 0;
  71          bit adjust_en;
  72          // æ—¶æ§æ¨¡å¼0ï¼š100%6H 50%6H 0%
  73          // æ—¶æ§æ¨¡å¼1ï¼š100%4H 50%8H 0%
  74          // æ—¶æ§æ¨¡å¼2ï¼š100%5H 70%3H 50%4H 0%
  75          // æ—¶æ§æ¨¡å¼3ï¼š100%4H 70%4H 50%4H 0%
  76          // æ—¶æ§æ¨¡å¼4ï¼š100%4H 60%2H 30%3H 60%2H 100%1H 0%
  77          void flag_init();
  78          typedef struct
  79          {
  80              u16 b; // å½“å‰äº®åº¦
  81              u8 t;  // å½“å‰äº®åº¦ä¿æŒæ—¶é—´,255æ—¶æ§ç»“æŸ
  82          } t_ctrl_list_t;
  83          
  84          t_ctrl_list_t t_ctrl_lis_0[3] =
  85              {
  86                  {MAX_DUTY, 6}, {_50_DUTY, 6}, {0, 255} // 6 6
  87          };
  88          
  89          t_ctrl_list_t code t_ctrl_lis_1[3] =
  90              {
  91                  {MAX_DUTY, 4}, {_50_DUTY, 8}, {0, 255}};
  92          
  93          t_ctrl_list_t code t_ctrl_lis_2[4] =
  94              {
  95                  {MAX_DUTY, 5}, {_70_DUTY, 3}, {_50_DUTY, 4}, {0, 255} // 534
  96          };
  97          
  98          t_ctrl_list_t code t_ctrl_lis_3[4] =
  99              {
 100                  {MAX_DUTY, 4}, {_70_DUTY, 4}, {_50_DUTY, 4}, {0, 255} // 444
 101          };
 102          
 103          t_ctrl_list_t code t_ctrl_lis_4[6] =
 104              {
 105                  {MAX_DUTY, 4}, {_60_DUTY, 2}, {_30_DUTY, 3}, {_60_DUTY, 2}, {MAX_DUTY, 1}, {0, 255} // 42321
 106          };
 107          
 108          t_ctrl_list_t *p_list;
 109          
 110          extern u16 cap0_val;
 111          extern u16 cap1_val;
 112          
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 3   

 113          extern void led_pwr_on(void);
 114          extern void cmp_duty(void);
 115          extern void led_plus(void);
 116          extern void led_sub(void);
 117          extern void cal_pwm_in_duty(void);
 118          
 119          
 120          u16 ajust_duty;
 121          // 20æ¡£ç”µä½å™¨è°ƒèŠ‚pwm   60%-62%-64%-66%- 68%-70%-72%-74%-76%6-7896-80%--82. 5%-85%-87.5%-90%-92%-94%-
             -96%-98%-100%
 122          // ä¿®æ”¹ä¸º40æ¡£ç”µä½å™¨è°ƒèŠ‚ pwm
 123          void adjust_pwm()
 124          {
 125   1          static u16 last_level = 0xFF;           // è®°å½•ä¹‹å‰çš„æŒ¡ä½
 126   1          u16 cur_level = adjust_val / LEVLE_PER; // è®¡ç®—å½“å‰æŒ¡ä½
 127   1      
 128   1          if (adjust_en == 1)
 129   1          {
 130   2      #if 0 // 20çº§æŒ¡ä½è°ƒèŠ‚ï¼š
                      if (adjust_val > 3680) // 4.5Vå¯¹åº”çš„ADå€¼
                      {
                          ajust_duty = 6000;
                      }
                      if (0 < adjust_val && adjust_val < LEVLE_PER)
                      {
                          ajust_duty = 3600;
                      }
                      else if (LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 2)
                      {
                          ajust_duty = 3720;
                      }
                      else if (2 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 3)
                      {
                          ajust_duty = 3840;
                      }
                      else if (3 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 4)
                      {
                          ajust_duty = 3960;
                      }
                      else if (4 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 5)
                      {
                          ajust_duty = 4080;
                      }
                      else if (5 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 6)
                      {
                          ajust_duty = 4200;
                      }
                      else if (6 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 7)
                      {
                          ajust_duty = 4320;
                      }
                      else if (7 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 8)
                      {
                          ajust_duty = 4440;
                      }
                      else if (8 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 9)
                      {
                          ajust_duty = 4560;
                      }
                      else if (9 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 10)
                      {
                          ajust_duty = 4680;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 4   

                      }
                      else if (10 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 11)
                      {
                          ajust_duty = 4800;
                      }
                      else if (11 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 12)
                      {
                          ajust_duty = 4950;
                      }
                      else if (12 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 13)
                      {
                          ajust_duty = 5100;
                      }
                      else if (13 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 14)
                      {
                          ajust_duty = 5250;
                      }
                      else if (14 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 15)
                      {
                          ajust_duty = 5400;
                      }
                      else if (15 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 16)
                      {
                          ajust_duty = 5520;
                      }
                      else if (16 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 17)
                      {
                          ajust_duty = 5640;
                      }
                      else if (17 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 18)
                      {
                          ajust_duty = 5760;
                      }
                      else if (18 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 19)
                      {
                          ajust_duty = 5880;
                      }
                      else if (19 * LEVLE_PER < adjust_val && adjust_val < LEVLE_PER * 20)
                      {
                          ajust_duty = 6000;
                      }
                      // ajust_duty=5760;
              #endif
 217   2      
 218   2              if (adjust_val > 3680) // è¶…å‡ºäº†4.5Vå¯¹åº”çš„ADå€¼
 219   2              {
 220   3                  ajust_duty = 6000;
 221   3                  last_level = cur_level;
 222   3                  return;
 223   3              }
 224   2      
 225   2              if (0 == cur_level) // æœ€å°æŒ¡ä½
 226   2              {
 227   3                  ajust_duty = 3600;
 228   3                  last_level = cur_level;
 229   3                  return;
 230   3              }
 231   2      
 232   2              if (cur_level >= ADJUST_STEP) // æœ€å¤§æŒ¡ä½
 233   2              {
 234   3                  ajust_duty = 6000;
 235   3                  last_level = cur_level;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 5   

 236   3                  return;
 237   3              }
 238   2      
 239   2              if (last_level == cur_level)
 240   2              {
 241   3                  // ä¹‹å‰çš„æŒ¡ä½å’Œå½“å‰è®¡ç®—å¾—å‡ºçš„æŒ¡ä½ä¸€æ ·ï¼Œä¸è°ƒèŠ‚
 242   3                  return;
 243   3              }
 244   2      
 245   2              ajust_duty = 3600 + cur_level * ((6000 - 3600) / ADJUST_STEP);
 246   2              last_level = cur_level;
 247   2          }
 248   1      }
 249          
 250          //
 251          u16 ex_temp_t = 0;    // æ¸©åº¦è®¡æ•°å€¼ï¼Œé¢„è®¡æ¯ç§’åŠ ä¸€
 252          u8 ex_temp_cnt = 0;   // è¿‡æ¸©é™åŠŸç‡å¤„ç†æ¬¡æ•°ï¼Œç¬¬ä¸€æ¬¡é™åˆ°90% ç¬¬äºŒæ¬¡80%-----
 253          u8 ex_temp_state = 1; // æ ‡å¿—ä½ï¼Œæ¸©åº¦æ‰«æçš„åŠä¸ªå°æ—¶æ˜¯å¦åˆ°æ¥
 254          
 255          u16 pwm_save[10] = 0; // æ£€æµ‹æ¸©åº¦æ§åˆ¶ä¸­ï¼Œä½¿ç”¨åˆ°çš„æ•°ç»„
 256          u16 ex_duty = 0; // æ¸©åº¦æ§åˆ¶ä¸­ï¼Œå­˜æ”¾ç»è¿‡æ¸©åº¦é™åˆ¶åï¼Œå¯è°ƒçš„ã€æœ€å¤§çš„pwmå ç©ºæ¯”
 257          bit extemp_flag = 0; // æ ‡å¿—ä½ï¼Œæ˜¯å¦æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­
 258          bit extemp_tctrl_flag = 0;
 259          #if 0
              void ex_temp_adjust_timer() // è¿‡æ¸©é™åŠŸç‡ å®šæ—¶åˆ¤æ–­ æ¯ç§’æ‰§è¡Œä¸€æ¬¡
              {
                  // printf("ntc_val=%d  ex_temp_cnt=%d   ex_temp_t=%d  \r\n",(int)pwm_in_duty,(int)c_duty,(int)ex_temp_
             -t);
                  
                  // å¦‚æœä½¿èƒ½äº†æ¸©åº¦æ£€æµ‹åŠŸèƒ½ å¹¶ä¸” æ—¶æ§åŠŸèƒ½ æœªä½¿èƒ½
                  if (ex_temp_en == 1 && t_ctrl.en == 0) 
                  {
                      // ntc_val=adjust_val;
                      if (extemp_tctrl_flag == 1)
                      {
                          pwm_save[0] = max_duty;
                          ex_temp_cnt = 0;
                          extemp_tctrl_flag = 0;
                      }
              
                      // åŠå°æ—¶å¤„ç†ä¸€æ¬¡ ADå€¼è¶Šå° æ¸©åº¦è¶Šé«˜
                      /*
                          å¦‚æœåŠä¸ªå°æ—¶åˆ°æ¥ï¼Œæ£€æµ‹åˆ°æ¸©åº¦è¿‡å¤§ (æ¸©åº¦è¶Šå¤§ï¼Œæ£€æµ‹åˆ°çš„adå€¼è¶Šå°) 
                      */
                      if (ntc_val < _3_1V && ex_temp_state == 1) 
                      {
                          pwm_save[ex_temp_cnt] = pwm_in_duty; 
              
                          ex_duty = pwm_save[0] - (pwm_save[0] / 10 * (ex_temp_cnt + 1)); // ç¬¬ä¸€æ¬¡é™åˆ°90%ï¼Œä¹‹å
             -æ¯æ¬¡å°†10%
                          ex_temp_state = 0;                                              // å¤„ç†å®Œæˆ åŠå°æ—¶åå†
             -å¼€å¯
                          ex_temp_t = 0; // æ¸…ç©ºæ¸©åº¦æ—¶é—´è®¡æ•°
              
                          max_duty = ex_duty; // æ›´æ–°å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”
                          ex_temp_cnt++; // æ¸©åº¦è¿‡çƒ­æ¬¡æ•°åŠ ä¸€
                          if (ex_temp_cnt > 9)  // å¦‚æœè¿‡çƒ­å¤§äº9æ¬¡ï¼Œå°†å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”è®¾ç½®ä¸º0%
                          {
                              max_duty = 0;
                          }
              
                          extemp_flag = 1; // è¡¨ç¤ºæ£€æµ‹åˆ°äº†æ¸©åº¦è¿‡çƒ­
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 6   

                      }
              
                      // æ¸©åº¦é™ä¸‹æ¥å ä¸å¹²é¢„æœ€å¤§å€¼ å¹¶ä¸”è®¡æ•°ç½®0 ä¸‹æ¬¡è¿‡æ¸©å†ä»90%å¼€å§‹
                      /*  
                          å¦‚æœæ£€æµ‹åˆ°æ¸©åº¦æœ‰ä¸‹é™ï¼Œè¿™é‡Œæ¯ç§’ä¼šè¿›å…¥ä¸€æ¬¡
                      */
                      if (ntc_val > _3_1V) 
                      {
                          ex_temp_cnt = 0;
                          
                          /*
                              å¦‚æœä¹‹å‰æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­ï¼Œå¹¶ä¸”åŠä¸ªå°æ—¶çš„æ‰«æå‘¨æœŸåˆ°æ¥
                          */
                          if (extemp_flag == 1 && ex_temp_state == 1) 
                          {
                              if (extemp_tctrl_flag == 0)
                              {
                                  if (adjust_en == 1)
                                  {
                                      if (_3_1.en == 1)
                                          max_duty = pwm_in_duty_xuwei;
                                      else
                                          max_duty = ajust_duty;
                                  }
              
                                  if (adjust_en == 0)
                                  {
                                      if (_3_1.en == 1)
                                          max_duty = ex_pwm_in_duty;
                                      else
                                          max_duty = pwm_save[0];
                                  }
              
                                  if (P00 == 0)
                                  {
                                      if (max_duty > ex_max_duty)
                                      {
                                          max_duty = ex_max_duty;
                                      }
                                  }
                              }
              
                              if (extemp_tctrl_flag == 1)
                              {
                                  extemp_tctrl_flag = 0;
                                  extemp_flag = 0;
                                  ex_temp_cnt = 0;
                                  return;
                              }
                          }
                      }
              
                      ex_temp_t++;
                      if (ex_temp_t == L_TEMP_PWR_T) // å¦‚æœè¶…è¿‡äº†30åˆ†é’Ÿ
                      {
                          ex_temp_t = 0; // åŠå°æ—¶è®¡æ•°æ¸…é›¶
                          ex_temp_state = 1;
                          // extemp_flag=0;
                      }
              
                      //    if(extemp_tctrl_flag==1)
                      //                      {
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 7   

                      //                              pwm_save[0]=max_duty;
                      //                      }
                  }
              
                  is_pwr_down = 1; // ä½¿èƒ½ç¼“æ…¢å‡é™åŠŸç‡ï¼Œç»™æ ‡å¿—ä½ç½®ä¸€
                  // printf("ex_temp_state=%d\r\n",(int)ex_temp_state);
                  // printf("pwm_in_duty= %d  t= %d  ajust_duty=%d  c_duty=%d adjust_val=%d pwm_save[0]=%d\r\n", (int)pw
             -m_in_duty,(int)t_ctrl.t,(int)ajust_duty,(int)c_duty,(int)adjust_val,(int)pwm_save[0]);
              }
              #endif
 366          
 367          #if 0
              volatile u32 temperature_scan_cnt = 0; // æ¸©åº¦æ‰«ææ—¶é—´è®¡æ•°ï¼Œåœ¨å®šæ—¶å™¨ä¸­ç´¯åŠ 
              volatile u8 temperature_status = 0;// çŠ¶æ€æœºï¼Œè®°å½•å½“å‰æ¸©åº¦çŠ¶æ€
              
              void ex_temp_adjust_timer() // è¿‡æ¸©é™åŠŸç‡ å®šæ—¶åˆ¤æ–­ æ¯ç§’æ‰§è¡Œä¸€æ¬¡
              { 
                  // å¦‚æœä½¿èƒ½äº†æ¸©åº¦æ£€æµ‹åŠŸèƒ½ å¹¶ä¸” æ—¶æ§åŠŸèƒ½ æœªä½¿èƒ½
                  if (ex_temp_en == 1 && t_ctrl.en == 0) 
                  { 
                      if (extemp_tctrl_flag == 1)
                      {
                          pwm_save[0] = max_duty;
                          ex_temp_cnt = 0;
                          extemp_tctrl_flag = 0;
                      }
              
                      // åŠå°æ—¶å¤„ç†ä¸€æ¬¡ ADå€¼è¶Šå° æ¸©åº¦è¶Šé«˜
                      /*
                          å¦‚æœåŠä¸ªå°æ—¶åˆ°æ¥ï¼Œæ£€æµ‹åˆ°æ¸©åº¦è¿‡å¤§ (æ¸©åº¦è¶Šå¤§ï¼Œæ£€æµ‹åˆ°çš„adå€¼è¶Šå°) 
                      */
                      if (ntc_val < _3_1V && ex_temp_state == 1) 
                      {
                          pwm_save[ex_temp_cnt] = pwm_in_duty; 
              
                          ex_duty = pwm_save[0] - (pwm_save[0] / 10 * (ex_temp_cnt + 1)); // ç¬¬ä¸€æ¬¡é™åˆ°90%ï¼Œä¹‹å
             -æ¯æ¬¡å°†10%
                          ex_temp_state = 0;                                              // å¤„ç†å®Œæˆ åŠå°æ—¶åå†
             -å¼€å¯
                          ex_temp_t = 0; // æ¸…ç©ºæ¸©åº¦æ—¶é—´è®¡æ•°
              
                          max_duty = ex_duty; // æ›´æ–°å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”
                          ex_temp_cnt++; // æ¸©åº¦è¿‡çƒ­æ¬¡æ•°åŠ ä¸€
                          if (ex_temp_cnt > 9)  // å¦‚æœè¿‡çƒ­å¤§äº9æ¬¡ï¼Œå°†å¯è°ƒçš„æœ€å¤§å ç©ºæ¯”è®¾ç½®ä¸º0%
                          {
                              max_duty = 0;
                          }
              
                          extemp_flag = 1; // è¡¨ç¤ºæ£€æµ‹åˆ°äº†æ¸©åº¦è¿‡çƒ­
                      }
              
                      if (ntc_val > _3_1V) // æ¸©åº¦é™ä¸‹æ¥å ä¸å¹²é¢„æœ€å¤§å€¼ å¹¶ä¸”è®¡æ•°ç½®0 ä¸‹æ¬¡è¿‡æ¸©å†ä»9
             -0%å¼€å§‹
                      {
                          ex_temp_cnt = 0;
                          
                          /*
                              å¦‚æœä¹‹å‰æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­ï¼Œå¹¶ä¸”åŠä¸ªå°æ—¶çš„æ‰«æå‘¨æœŸåˆ°æ¥
                          */
                          if (extemp_flag == 1 && ex_temp_state == 1) 
                          {
                              if (extemp_tctrl_flag == 0)
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 8   

                              {
                                  if (adjust_en == 1)
                                  {
                                      if (_3_1.en == 1)
                                          max_duty = pwm_in_duty_xuwei;
                                      else
                                          max_duty = ajust_duty;
                                  }
              
                                  if (adjust_en == 0)
                                  {
                                      if (_3_1.en == 1)
                                          max_duty = ex_pwm_in_duty;
                                      else
                                          max_duty = pwm_save[0];
                                  }
              
                                  if (P00 == 0)
                                  {
                                      if (max_duty > ex_max_duty)
                                      {
                                          max_duty = ex_max_duty;
                                      }
                                  }
                              }
              
                              if (extemp_tctrl_flag == 1)
                              {
                                  extemp_tctrl_flag = 0;
                                  extemp_flag = 0;
                                  ex_temp_cnt = 0;
                                  return;
                              }
                          } // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°æ¸©åº¦è¿‡çƒ­ï¼Œå¹¶ä¸”åŠä¸ªå°æ—¶çš„æ‰«æå‘¨æœŸåˆ°æ¥
                      }
              
                      // ex_temp_t++;
                      // if (ex_temp_t == L_TEMP_PWR_T) // å¦‚æœè¶…è¿‡äº†30åˆ†é’Ÿ
                      // {
                      //     ex_temp_t = 0; // åŠå°æ—¶è®¡æ•°æ¸…é›¶
                      //     ex_temp_state = 1;
                      // } 
                  }
              
                  is_pwr_down = 1; // ä½¿èƒ½ç¼“æ…¢å‡é™åŠŸç‡ï¼Œç»™æ ‡å¿—ä½ç½®ä¸€ 
              }
              #endif
 462          
 463          void set_pwm_duty(void)
 464          {
 465   1          u16 duty_tmp;
 466   1          //    if(c_duty != 0)
 467   1          {
 468   2      
 469   2              duty_tmp = MAX_DUTY - c_duty;
 470   2              // c_duty = 10;
 471   2              STMR0_CMPAH = STMR_CMPA_VAL_H(((c_duty) >> 8) & 0xFF); // æ¯”è¾ƒå€¼
 472   2              STMR0_CMPAL = STMR_CMPA_VAL_L(((c_duty) >> 0) & 0xFF); // æ¯”è¾ƒå€¼
 473   2              STMR_LOADEN |= STMR_0_LOAD_EN(0x1);                    // è‡ªåŠ¨è£…è½½ä½¿èƒ½
 474   2          }
 475   1          //    else
 476   1          {
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 9   

 477   2          }
 478   1      
 479   1          // TMR2_PWMH  = TMR_PWM_VAL_H((duty_tmp >> 8) & 0xFF);                      // å ç©ºæ¯”è®¾ç½®å€¼
 480   1          // TMR2_PWML  = TMR_PWM_VAL_L((duty_tmp >> 0) & 0xFF);
 481   1      }
 482          
 483          u8 adjust_ms = 0;
 484          void cap_timer(void)
 485          {
 486   1          if (cap_10ms_cnt < 10)
 487   1          {
 488   2              cap_10ms_cnt++;
 489   2          }
 490   1          pwr_on_cnt++;
 491   1          adjust_ms++;
 492   1      }
 493          
 494          // æ”¾åœ¨while,æ²¡10msè·å–ä¸€æ¬¡PWMå ç©ºæ¯”
 495          // è¿ç»­è·å–5æ¬¡ï¼Œå ç©ºæ¯”ç¨³å®šæ‰è¾“å‡º
 496          u16 duty_buff[5];
 497          u8 duty_cnt = 0;
 498          // ä¸Šç”µé‡‡æ ·5æ¬¡å®Œæˆæ ‡å¿—ä¸º
 499          u8 simple_over = 0;
 500          // æ”¾ä¸»å¾ªç¯
 501          void get_duty(void)
 502          {
 503   1          // 10msè·å–ä¸€æ¬¡
 504   1          if (cap_10ms_cnt >= 10)
 505   1          {
 506   2              cap_10ms_cnt = 0;
 507   2              if (_3_1.en == 1) // ä¸‰åˆä¸€åŠŸèƒ½å¼€å¯æ‰è°ƒå…‰
 508   2              {
 509   3                  // éä¸‰åˆä¸€ä¸ä¼šæ›´æ–°pwm_in_duty
 510   3                  cal_pwm_in_duty();
 511   3              }
 512   2              // å¤„ç†é™åŠŸç‡ï¼Œæ—¶æ§æ¿€æ´»ï¼Œé™åˆ¶å¯è°ƒçš„å ç©ºæ¯”èŒƒå›´
 513   2              // å»¶æ—¶å¼€æœºæ¨¡å¼ï¼Œå¼ºåˆ¶pwm_in_duty=0
 514   2      
 515   2              pwm_in_handler();
 516   2              cmp_duty();
 517   2          }
 518   1      
 519   1          if (adjust_ms == 3)
 520   1          {
 521   2              adjust_ms = 0;
 522   2              led_plus();
 523   2              led_sub();
 524   2          }
 525   1      
 526   1          led_pwr_on();
 527   1      }
 528          
 529          // è®¡ç®—ä¸‰åˆä¸€çš„å ç©ºæ¯”,å‚¨å­˜pwm_in_duty
 530          void cal_pwm_in_duty(void)
 531          {
 532   1          u8 i;
 533   1          if (cap1_val == 0 && cap0_val == 0)
 534   1          {
 535   2              if (P14 == 0)
 536   2              {
 537   3                  // å ç©ºæ¯” 0
 538   3                  pwm_in_duty = 0;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 10  

 539   3              }
 540   2              if (P14 == 1)
 541   2              {
 542   3                  pwm_in_duty = 6000;
 543   3              }
 544   2          }
 545   1          else
 546   1          {
 547   2              pwm_in_duty = (u32)MAX_DUTY * (cap1_val + 1);
 548   2              pwm_in_duty = pwm_in_duty / (cap0_val + 1);
 549   2          }
 550   1      
 551   1          cap1_val = 0;
 552   1          cap0_val = 0;
 553   1          duty_buff[duty_cnt] = pwm_in_duty;
 554   1          duty_cnt++;
 555   1          if (duty_cnt == 5)
 556   1          {
 557   2              simple_over = 1;
 558   2              duty_cnt = 0;
 559   2          }
 560   1          if (simple_over == 1)
 561   1          {
 562   2              pwm_in_duty = 0;
 563   2              for (i = 0; i < 5; i++)
 564   2              {
 565   3                  pwm_in_duty += duty_buff[i];
 566   3              }
 567   2              // æ±‚å¹³å‡
 568   2              pwm_in_duty = pwm_in_duty / 5;
 569   2          }
 570   1          // printf("3_1_pwm_in_duty= %d    c_duty=%d\r\n",(int)pwm_in_duty,(int)c_duty);
 571   1          // pwm_in_duty=5000;
 572   1      
 573   1          if (adjust_en == 1)
 574   1          {
 575   2              pwm_in_duty_xuwei = pwm_in_duty * ajust_duty / 6000;
 576   2              pwm_in_duty = pwm_in_duty_xuwei;
 577   2          }
 578   1          ex_pwm_in_duty = pwm_in_duty;
 579   1      }
 580          
 581          // å¯¹æ¯”å½“å‰çš„dutyæ˜¯å¦å‘ç”Ÿå˜åŒ–
 582          void cmp_duty(void)
 583          {
 584   1          if (led_state == LED_PWR_ON)
 585   1              return;
 586   1      
 587   1          if (pwm_in_duty > 10)
 588   1          {
 589   2              if ((pwm_in_duty - 10) > c_duty)
 590   2              {
 591   3                  led_state = LED_ADJ_P;
 592   3              }
 593   2              if ((pwm_in_duty + 10) < c_duty)
 594   2              {
 595   3                  led_state = LED_ADJ_S;
 596   3              }
 597   2          }
 598   1          else
 599   1          {
 600   2              if (pwm_in_duty > c_duty)
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 11  

 601   2              {
 602   3                  led_state = LED_ADJ_P;
 603   3              }
 604   2              if (pwm_in_duty < c_duty)
 605   2              {
 606   3                  led_state = LED_ADJ_S;
 607   3              }
 608   2          }
 609   1      }
 610          
 611          // ä¸Šç”µledç¼“æ…¢å¯åŠ¨
 612          // æ¯10msæ‰§è¡Œä¸€æ¬¡ï¼Œc_dutyæ¯æ¬¡+30
 613          float gamma = 1;
 614          void debug_putchar(u8 uart_data);
 615          
 616          // float step = 90;
 617          float step = 70;
 618          
 619          float mi;  // å¹‚
 620          float rus; // 10çš„å¹‚æ¬¡æ–¹
 621          float r_ms = 0;
 622          u16 rus_duty; // æ”¾å¤§60å€
 623          
 624          // 1msè°ƒç”¨ä¸€æ¬¡     LIN æ”¹ åŠ å…¥ç”µä½å™¨åˆ¤æ–­
 625          void led_pwr_on(void)
 626          {
 627   1          if (led_state == LED_PWR_ON && simple_over == 1)
 628   1          {
 629   2              // æ²¡æœ‰ç”µä½å™¨æ—¶
 630   2              // æ²¡æœ‰ä¸‰åˆä¸€åŠŸèƒ½ï¼Œä¸Šç”µé»˜è®¤æœ€å¤§å ç©ºæ¯”
 631   2              //  æœ‰ä¸‰åˆä¸€åŠŸèƒ½ï¼ŒæŒ‰é‡‡ç”¨çš„å ç©ºæ¯”è°ƒå…‰
 632   2              if (adjust_en == 0)
 633   2              {
 634   3                  if (_3_1.en == 0)
 635   3                  {
 636   4                      pwm_in_duty = max_duty;
 637   4                  }
 638   3                  r_ms = step / 12;
 639   3                  if (r_ms < 1)
 640   3                      r_ms = 10;
 641   3                  if (pwr_on_cnt < r_ms)
 642   3                      return; // æ—¶é—´æœªåˆ°ä¸è°ƒæ•´
 643   3                  pwr_on_cnt = 0;
 644   3                  if (c_duty < pwm_in_duty)
 645   3                  {
 646   4                      mi = (step - 1) / (253 / 3) - 1;
 647   4                      step += 0.5;
 648   4                      c_duty = pow(5, mi) * 60;
 649   4                  }
 650   3                  if (c_duty >= pwm_in_duty)
 651   3                  {
 652   4                      c_duty = pwm_in_duty;
 653   4                      led_state = LED_NULL;
 654   4                  }
 655   3                  set_pwm_duty();
 656   3              }
 657   2              if (adjust_en == 1) // æœ‰æ²¡æœ‰ä¸‰åˆä¸€åŠŸèƒ½ï¼Œä¸Šç”µéƒ½é»˜è®¤ç”µä½å™¨çš„æœ€å¤§å ç©ºæ¯”
 658   2              {
 659   3                  if (_3_1.en == 0)
 660   3                  {
 661   4                      pwm_in_duty = ajust_duty;
 662   4                  }
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 12  

 663   3                  if (_3_1.en == 1)
 664   3                  {
 665   4                      pwm_in_duty = pwm_in_duty_xuwei;
 666   4                  }
 667   3                  {
 668   4                      r_ms = step / 12;
 669   4                      if (r_ms < 1)
 670   4                          r_ms = 10;
 671   4                      if (pwr_on_cnt < r_ms)
 672   4                          return; // æ—¶é—´æœªåˆ°ä¸è°ƒæ•´
 673   4                      pwr_on_cnt = 0;
 674   4                      if (c_duty < pwm_in_duty)
 675   4                      {
 676   5                          mi = (step - 1) / (253 / 3) - 1;
 677   5                          step += 0.5;
 678   5                          c_duty = pow(5, mi) * 60;
 679   5                      }
 680   4                      if (c_duty >= pwm_in_duty)
 681   4                      {
 682   5                          c_duty = pwm_in_duty;
 683   5                          led_state = LED_NULL;
 684   5                      }
 685   4                      set_pwm_duty();
 686   4                  }
 687   3              }
 688   2          }
 689   1          // printf("pwm_in_duty= %d   t= %d    t_ctrl.level=%d    c_duty=%d\r\n", (int)pwm_in_duty,(int)t_ctrl.
             -t,(int)ajust_duty,(int)c_duty);
 690   1      }
 691          
 692          void led_plus(void)
 693          {
 694   1          if (led_state != LED_ADJ_P)
 695   1              return;
 696   1          if (c_duty < pwm_in_duty)
 697   1          {
 698   2              if (is_pwr_down) // ç¼“æ…¢å‡é™
 699   2                  c_duty += 1;
 700   2              else
 701   2                  c_duty += 10;
 702   2          }
 703   1      
 704   1          if (c_duty >= pwm_in_duty)
 705   1          {
 706   2              c_duty = pwm_in_duty;
 707   2              led_state = LED_NULL;
 708   2              gamma = c_duty;
 709   2              is_pwr_down = 0; // å®Œæˆç¼“æ…¢å‡é™
 710   2          }
 711   1          set_pwm_duty();
 712   1      }
 713          
 714          void led_sub(void)
 715          {
 716   1          if (led_state != LED_ADJ_S)
 717   1              return;
 718   1      
 719   1          if (c_duty > pwm_in_duty)
 720   1          {
 721   2              if (is_pwr_down)
 722   2                  c_duty -= 1;
 723   2              else
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 13  

 724   2              {
 725   3                  if (c_duty > 50)
 726   3                  {
 727   4      
 728   4                      c_duty -= 10;
 729   4                  }
 730   3                  else
 731   3                  {
 732   4                      c_duty -= 1;
 733   4                  }
 734   3              }
 735   2          }
 736   1          if (c_duty <= pwm_in_duty)
 737   1          {
 738   2              c_duty = pwm_in_duty;
 739   2              gamma = c_duty;
 740   2              is_pwr_down = 0; // å®Œæˆç¼“æ…¢å‡é™
 741   2              led_state = LED_NULL;
 742   2          }
 743   1          set_pwm_duty();
 744   1      }
 745          
 746          // æœ‰æ²¡æœ‰é™åŠŸç‡
 747          #define LOW_PWR_R7 P00
 748          // æœ‰æ²¡æœ‰ä¸‰åˆä¸€
 749          #define _3_1_R14 P02
 750          // æœ‰æ²¡æœ‰æ—¶ç©º
 751          #define T_C_R11 P03
 752          
 753          #define T_C_R8 P13
 754          #define T_C_R9 P12
 755          #define T_C_R10 P11
 756          
 757          // é™åŠŸç‡ã€æ—¶ç©ºã€ä¸‰åˆä¸€åŠŸèƒ½
 758          void option_fun(void)
 759          {
 760   1          flag_init();
 761   1          // p13è¾“å…¥ä¸Šæ‹‰ï¼Œæ—¶ç©ºç»„åˆR8
 762   1          P1_MD0 &= ~(GPIO_P13_MODE_SEL(0x3));
 763   1          P1_PU |= (GPIO_P13_PULL_UP(0x1));
 764   1          P1_PD |= (GPIO_P13_PULL_PD(1));
 765   1          //   æ—¶ç©ºç»„åˆR9
 766   1          P1_MD0 &= ~(GPIO_P12_MODE_SEL(0x3));
 767   1          P1_PU |= (GPIO_P12_PULL_UP(0x1));
 768   1          // æ—¶ç©ºç»„åˆR10
 769   1          P1_MD0 &= ~(GPIO_P11_MODE_SEL(0x3));
 770   1          P1_PU |= (GPIO_P11_PULL_UP(0x1));
 771   1          // é™åŠŸç‡æœ‰/æ—  R7
 772   1          P0_MD0 &= ~(GPIO_P00_MODE_SEL(0x3));
 773   1          P0_PU |= (GPIO_P00_PULL_UP(0x1));
 774   1          // ä¸‰åˆä¸€æœ‰/æ—  R14
 775   1          P0_MD0 &= ~(GPIO_P02_MODE_SEL(0x3));
 776   1          P0_PU |= (GPIO_P02_PULL_UP(0x1));
 777   1          // æ—¶ç©ºæœ‰/æ—  R11
 778   1          P0_MD0 &= ~(GPIO_P03_MODE_SEL(0x3));
 779   1          P0_PU |= (GPIO_P03_PULL_UP(0x1));
 780   1      
 781   1          if (LOW_PWR_R7 == 0) // ä½ç”µå¹³æœ‰é™åŠŸç‡
 782   1          {
 783   2              l_pwr.en = 1;
 784   2              printf("l_pwr.en = 1\r\n");
 785   2          }
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 14  

 786   1          else
 787   1          {
 788   2              l_pwr.en = 0;
 789   2              printf("l_pwr.en = 0\r\n");
 790   2          }
 791   1          if (adc0_val > 4000) // LIN æ”¹ åŠ å…¥äº†ntcå’Œç”µä½å™¨ADå€¼çš„åˆ¤æ–­ ntcå’Œç”µä½å™¨éƒ½ä¸Šæ‹‰
 792   1          {
 793   2              ex_temp_en = 0; // ä¸ä½¿èƒ½ æ¸©åº¦æ£€æµ‹ åŠŸèƒ½
 794   2              printf("ex_temp_en = 0\r\n");
 795   2          }
 796   1          else
 797   1          {
 798   2              ex_temp_en = 1; // ä½¿èƒ½ æ¸©åº¦æ£€æµ‹ åŠŸèƒ½
 799   2              printf("ex_temp_en = 1\r\n");
 800   2          }
 801   1          if (adc1_val > 4000)
 802   1          {
 803   2              adjust_en = 0;
 804   2              printf("adjust_en = 0\r\n");
 805   2          }
 806   1          else
 807   1          {
 808   2              adjust_en = 1;
 809   2              printf("adjust_en = 1\r\n");
 810   2          }
 811   1          if (_3_1_R14 == 1) // é«˜ç”µå¹³æœ‰ä¸‰åˆä¸€
 812   1          {
 813   2              _3_1.en = 1;
 814   2              // simple_over = 1;
 815   2              printf("_3_1.en  = 1\r\n");
 816   2          }
 817   1          else
 818   1          {
 819   2              _3_1.en = 0;
 820   2              simple_over = 1;
 821   2              printf("_3_1.en  = 0\r\n");
 822   2          }
 823   1      
 824   1          // ä½ç”µå¹³ä½¿èƒ½ æ—¶æ§
 825   1          if (T_C_R11 == 0) //  0
 826   1          {
 827   2              t_ctrl.en = 1;
 828   2              printf("t_ctrl.en = 1\r\n");
 829   2          }
 830   1          else
 831   1          {
 832   2              t_ctrl.en = 0;
 833   2              printf("t_ctrl.en = 0\r\n");
 834   2          }
 835   1      
 836   1          // æ—¶æ§æ¨¡å¼0ï¼š100%6H 50%6H 0%
 837   1          // æ—¶æ§æ¨¡å¼1ï¼š100%4H 50%8H 0%
 838   1          // æ—¶æ§æ¨¡å¼2ï¼š100%5H 70%3H 50%4H 0%
 839   1          // æ—¶æ§æ¨¡å¼3ï¼š100%4H 70%4H 50%4H 0%
 840   1          // æ—¶æ§æ¨¡å¼4ï¼š100%4H 60%2H 30%3H 60%2H 100%1H 0%
 841   1      
 842   1          if (T_C_R8 == 1 && T_C_R9 == 1 && T_C_R10 == 1)
 843   1          {
 844   2              t_ctrl.list = 0;
 845   2              p_list = &t_ctrl_lis_0;
 846   2              printf("t_ctrl.list = 0 \r\n");
 847   2          }
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 15  

 848   1          else if (T_C_R8 == 0 && T_C_R9 == 1 && T_C_R10 == 1)
 849   1          {
 850   2              t_ctrl.list = 1;
 851   2              p_list = &t_ctrl_lis_1;
 852   2              printf("t_ctrl.list = 1\r\n ");
 853   2          }
 854   1          else if (T_C_R8 == 1 && T_C_R9 == 0 && T_C_R10 == 1)
 855   1          {
 856   2              t_ctrl.list = 2;
 857   2              p_list = &t_ctrl_lis_2;
 858   2              printf("t_ctrl.list = 2\r\n ");
 859   2          }
 860   1          else if (T_C_R8 == 1 && T_C_R9 == 1 && T_C_R10 == 0)
 861   1          {
 862   2              t_ctrl.list = 3;
 863   2              p_list = &t_ctrl_lis_3;
 864   2              printf("t_ctrl.list = 3\r\n ");
 865   2          }
 866   1          else if (T_C_R8 == 0 && T_C_R9 == 0 && T_C_R10 == 1)
 867   1          {
 868   2              t_ctrl.list = 4;
 869   2              p_list = &t_ctrl_lis_4;
 870   2              printf("t_ctrl.list = 4\r\n");
 871   2          }
 872   1      }
 873          
 874          // é™åŠŸç‡è®¡æ—¶å¤„ç†
 875          void l_pwr_timer_handler(void)
 876          {
 877   1          if (l_pwr.en == 1)
 878   1          {
 879   2              if (l_pwr.t < L_PWR_T) // å°æ—¶
 880   2              {
 881   3                  l_pwr.t++;
 882   3              }
 883   2              else
 884   2              {
 885   3                  // å¤§äº1å°æ—¶
 886   3      
 887   3                  extemp_tctrl_flag = 1;
 888   3                  if (adjust_en == 1) // ç”µä½å™¨ä½¿èƒ½
 889   3                  {
 890   4                      if (_3_1.en == 1) // æœ‰ä¸‰åˆä¸€åŠŸèƒ½å’Œç”µä½å™¨
 891   4                      {
 892   5                          // åˆ¤æ–­PWM_inå ç©ºæ¯”å¤§äº74
 893   5                          if (pwm_in_duty_xuwei > ajust_duty / 100 * 75) // LIN æ”¹  75%æ”¹æˆç”µä½å™¨çš„75%
 894   5                          {
 895   6                              max_duty = ajust_duty / 100 * 75;
 896   6                              l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 897   6                              l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 898   6                              is_pwr_down = 1;
 899   6                          }
 900   5                      }
 901   4                      else
 902   4                      {
 903   5                          max_duty = ajust_duty / 100 * 75;
 904   5                          l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 905   5                          l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 906   5                          is_pwr_down = 1;
 907   5                      }
 908   4                  }
 909   3      
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 16  

 910   3                  if (adjust_en == 0) // æ— ç”µä½å™¨
 911   3                  {
 912   4                      if (_3_1.en) // æœ‰ä¸‰åˆä¸€åŠŸèƒ½
 913   4                      {
 914   5                          // åˆ¤æ–­PWM_inå ç©ºæ¯”å¤§äº74
 915   5                          if (pwm_in_duty > _75_DUTY)
 916   5                          {
 917   6                              max_duty = _75_DUTY;
 918   6                              l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 919   6                              l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 920   6                              is_pwr_down = 1;
 921   6                          }
 922   5                      }
 923   4                      else
 924   4                      {
 925   5                          max_duty = _75_DUTY;
 926   5                          l_pwr.act = 1; // é™åŠŸç‡çŠ¶æ€
 927   5                          l_pwr.en = 0;  // å¤„ç†å®Œæˆï¼Œä½¿èƒ½é™åŠŸç‡
 928   5                          is_pwr_down = 1;
 929   5                      }
 930   4                  }
 931   3                  l_pwr.en = 0;
 932   3                  ex_max_duty = max_duty;
 933   3              }
 934   2          }
 935   1      }
 936          
 937          // å¤„ç†é™åŠŸç‡ï¼Œæ—¶æ§æ—¶ï¼Œå¯è°ƒçš„å ç©ºæ¯”èŒƒå›´
 938          // å»¶æ—¶å¼€æœºæ¨¡å¼ï¼Œå¼ºåˆ¶pwm_in_duty=0
 939          void pwm_in_handler(void)
 940          {
 941   1          // if(_3_1.en)     //æœ‰ä¸‰åˆä¸€åŠŸèƒ½
 942   1          {
 943   2              // æ—¶æ§å’Œé™åŠŸç‡æ¿€æ´»çŠ¶æ€ï¼Œæœ€å¤§å ç©ºæ¯”ä¸è¶…è¿‡é™åŠŸç‡ï¼Œæ—¶æ§, LIN æ”¹ è¿‡æ¸©é™å
             -ŠŸç‡è®¾å®šçš„å ç©ºæ¯”
 944   2              //                      if(t_ctrl.en == 1)
 945   2              //                      {
 946   2              //                              if(_3_1.en==1)
 947   2              //                {
 948   2              //                    pwm_in_duty = pwm_in_duty;
 949   2              //                }
 950   2              //
 951   2              //                              if(adjust_en==1)
 952   2              //                              {
 953   2              //                                      pwm_in_duty = ajust_duty;
 954   2              //                              }
 955   2              //                              if(_3_1.en==0&&adjust_en==0)
 956   2              //                              {
 957   2              //                                      pwm_in_duty = max_duty;
 958   2              //                              }
 959   2              //                      }
 960   2              if (t_ctrl.en == 0 && adjust_en == 1)
 961   2              {
 962   3                  if (_3_1.en == 1)
 963   3                  {
 964   4                      pwm_in_duty = pwm_in_duty_xuwei;
 965   4                  }
 966   3                  else
 967   3                  {
 968   4                      pwm_in_duty = ajust_duty;
 969   4                  }
 970   3              }
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 17  

 971   2              if (l_pwr.act == 1 || t_ctrl.en == 1)
 972   2              {
 973   3                  // è¿›å…¥é™åŠŸç‡æ¨¡å¼
 974   3      
 975   3                  if (adjust_en == 1 && _3_1.en == 1)
 976   3                  {
 977   4      
 978   4                      if (pwm_in_duty_xuwei > max_duty)
 979   4                      {
 980   5                          pwm_in_duty_xuwei = max_duty;
 981   5                      }
 982   4                      pwm_in_duty = pwm_in_duty_xuwei;
 983   4                  }
 984   3                  else
 985   3                  {
 986   4                      if (pwm_in_duty > max_duty)
 987   4                      {
 988   5                          pwm_in_duty = max_duty;
 989   5                      }
 990   4                  }
 991   3              }
 992   2              if (ex_temp_en == 1 && t_ctrl.en == 0)
 993   2              {
 994   3                  if (adjust_en == 0 && _3_1.en == 0)
 995   3                  {
 996   4                      pwm_in_duty = max_duty;
 997   4                  }
 998   3                  if (pwm_in_duty > max_duty)
 999   3                  {
1000   4                      pwm_in_duty = max_duty;
1001   4                  }
1002   3                  if (max_duty == 0)
1003   3                  {
1004   4                      pwm_in_duty = 0;
1005   4                  }
1006   3              }
1007   2          }
1008   1          // is_pwr_down=0;
1009   1          //    if(dly_pwr_on == 1)
1010   1          //    {
1011   1          //        // å»¶æ—¶å¯åŠ¨ï¼Œå¼ºåˆ¶pwm 0
1012   1          //        pwm_in_duty = 0;
1013   1          //    }
1014   1      }
1015          
1016          // 1sè°ƒç”¨ä¸€æ¬¡
1017          void t_ctrl_timer_handler(void)
1018          {
1019   1          if (t_ctrl.en == 1)
1020   1      
1021   1          {
1022   2              // å½“å‰åˆ—è¡¨æ—¶é—´é255ï¼Œå¦‚æœæ˜¯255åˆ™è¯´æ˜æ—¶ç©ºç»“æŸ
1023   2              if (p_list[t_ctrl.level].t != 255)
1024   2              {
1025   3                  //                  t_ctrl.list = 4;
1026   3                  //        p_list = &t_ctrl_lis_4;
1027   3                  t_ctrl.t++;
1028   3                  if (t_ctrl.t >= (p_list[t_ctrl.level].t * 60 * 60)) // æ”¹æˆ10s
1029   3                  // if(t_ctrl.t >= (p_list[t_ctrl.level].t * 10) )
1030   3                  {
1031   4                      t_ctrl.level++;
1032   4                      is_pwr_down = 1;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 18  

1033   4                      t_ctrl.t = 0;
1034   4                      max_duty = p_list[t_ctrl.level].b;
1035   4                      extemp_tctrl_flag = 1;
1036   4                      if (adjust_en == 1) // LIN æ”¹ åŠ å…¥ç”µä½å™¨æ—¶ å°†æœ€å¤§å€¼å˜æˆç”µä½å™¨çš„æœ€å¤§å€¼
1037   4                      {
1038   5                          switch (max_duty)
1039   5                          {
1040   6                          case 6000:
1041   6                              max_duty = ajust_duty;
1042   6                              break;
1043   6                          case 4200:
1044   6                              max_duty = ajust_duty / 10 * 7;
1045   6                              break;
1046   6                          case 3600:
1047   6                              max_duty = ajust_duty / 10 * 6;
1048   6                              break;
1049   6                          case 3000:
1050   6                              max_duty = ajust_duty / 2;
1051   6                              break;
1052   6                          case 1800:
1053   6                              max_duty = ajust_duty / 10 * 3;
1054   6                              break;
1055   6                          default:
1056   6                              break;
1057   6                          }
1058   5                      }
1059   4                      if (_3_1.en == 1 && ex_temp_en == 1 && t_ctrl.en == 0)
1060   4                      {
1061   5                          //  if(adjust_en==0)
1062   5                          {
1063   6                              if (ex_pwm_in_duty < max_duty)
1064   6                              {
1065   7                                  max_duty = ex_pwm_in_duty;
1066   7                              }
1067   6                          }
1068   5                          //                                                          else
1069   5                          //                                                          {
1070   5                          //                                                                  if(pwm_in_duty_xuwei<max_duty)
1071   5                          //                                                                  {
1072   5                          //                                                                          max_duty=pwm_in_duty_xuwei;
1073   5                          //                                                                  }
1074   5                          //                                                          }
1075   5                      }
1076   4                      pwm_in_duty = max_duty; // ä¿®å¤t_ctrl_lis_4ï¼ŒåŠŸç‡é™åˆ°30%å‡ä¸äº†60%
1077   4                      if (adjust_en == 1 && _3_1.en == 1)
1078   4                      {
1079   5                          pwm_in_duty_xuwei = max_duty;
1080   5                      }
1081   4                  }
1082   3              }
1083   2      
1084   2              //                              if(p_list[t_ctrl.level].t != 0)
1085   2              //                              {
1086   2              //                                      t_ctrl.level=0;
1087   2              //                              }
1088   2              // is_pwr_dow=0;
1089   2          }
1090   1          // printf("pwm_in_duty= %d  t= %d  ajust_duty=%d  max_duty=%d adjust_val=%d pwm_save[0]=%d\r\n", (int)
             -pwm_in_duty,(int)t_ctrl.t,(int)ajust_duty,(int)c_duty,(int)adjust_val,(int)pwm_save[0]);
1091   1          // printf("pwm_in_duty= %d   t= %d    t_ctrl.level=%d    c_duty=%d\r\n", (int)pwm_in_duty,(int)t_ctrl.
             -t,(int)ajust_duty,(int)c_duty);
1092   1      }
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 19  

1093          
1094          // 1ç§’è°ƒç”¨ä¸€æ¬¡
1095          extern u8 lvd_mode;
1096          extern volatile u8 lvd_flag;
1097          void dly_pwr_on_handler(void)
1098          {
1099   1          if (dly_pwr_on == 1) // å»¶æ—¶å¯åŠ¨
1100   1          {
1101   2              user_printf("lvd pwr low \n");
1102   2              dly_pwr_on_cnt++;
1103   2              if (dly_pwr_on_cnt >= 5)
1104   2              {
1105   3                  // åˆå§‹åŒ–å…¨å±€å˜é‡ï¼š
1106   3                  lvd_flag = 0;
1107   3                  dly_pwr_on_cnt = 0;
1108   3      
1109   3                  dly_pwr_on = 0;
1110   3      
1111   3                  c_duty = 0;
1112   3                  max_duty = MAX_DUTY;
1113   3      
1114   3                  t_ctrl.list = 0;
1115   3                  t_ctrl.t = 0;
1116   3                  t_ctrl.en = 0;
1117   3                  t_ctrl.level = 0;
1118   3      
1119   3                  l_pwr.en = 0;
1120   3                  l_pwr.act = 0;
1121   3                  l_pwr.t = 0;
1122   3      
1123   3                  _3_1.en = 0;
1124   3                  pwm_in_duty = 0;
1125   3                  ex_temp_en = 0;
1126   3                  adjust_en = 0;
1127   3                  gamma = 2;
1128   3                  option_fun();
1129   3      
1130   3                  led_state = LED_PWR_ON;
1131   3                  printf("LED_PWR_ON");
1132   3              }
1133   2          }
1134   1      }
1135          
1136          // åˆå§‹åŒ–å…¨å±€å˜é‡
1137          void flag_init()
1138          {
1139   1          lvd_flag = 0;
1140   1          dly_pwr_on_cnt = 0;
1141   1      
1142   1          dly_pwr_on = 0;
1143   1      
1144   1          c_duty = 0;
1145   1          max_duty = MAX_DUTY;
1146   1      
1147   1          t_ctrl.list = 0;
1148   1          t_ctrl.t = 0;
1149   1          t_ctrl.en = 0;
1150   1          t_ctrl.level = 0;
1151   1      
1152   1          l_pwr.en = 0;
1153   1          l_pwr.act = 0;
1154   1          l_pwr.t = 0;
C51 COMPILER V9.60.7.0   LED_CTRL                                                          12/30/2025 09:37:04 PAGE 20  

1155   1      
1156   1          _3_1.en = 0;
1157   1          pwm_in_duty = 0;
1158   1          ex_temp_en = 0;
1159   1          adjust_en = 0;
1160   1          gamma = 2;
1161   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3560    ----
   CONSTANT SIZE    =    328    ----
   XDATA SIZE       =    112       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      6    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
